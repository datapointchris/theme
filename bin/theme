#!/usr/bin/env bash
# Theme management - unified cross-platform theming
# Applies themes to terminal, tmux, fzf, shell, and more
# shellcheck disable=SC1091

set -euo pipefail

# Source the library (handle symlinks)
SCRIPT_PATH="${BASH_SOURCE[0]:-$0}"
if [[ -L "$SCRIPT_PATH" ]]; then
  SCRIPT_PATH="$(python3 -c "import os; print(os.path.realpath('$SCRIPT_PATH'))")"
fi
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
THEME_APP_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Source formatting library for colorized help
if [[ -f "$HOME/.local/shell/formatting.sh" ]]; then
  source "$HOME/.local/shell/formatting.sh"
elif [[ -f "$HOME/dotfiles/platforms/common/.local/shell/formatting.sh" ]]; then
  source "$HOME/dotfiles/platforms/common/.local/shell/formatting.sh"
fi

source "$THEME_APP_DIR/lib/lib.sh"
source "$THEME_APP_DIR/lib/storage.sh"
source "$THEME_APP_DIR/lib/sync.sh"

get_version() {
  git -C "$THEME_APP_DIR" describe --tags --always 2>/dev/null || echo "dev"
}

# Rename original functions and create filtered versions
eval "$(declare -f list_themes | sed '1s/list_themes/list_themes_unfiltered/')"
eval "$(declare -f list_themes_with_status | sed '1s/list_themes_with_status/list_themes_with_status_unfiltered/')"
eval "$(declare -f count_themes | sed '1s/count_themes/count_themes_unfiltered/')"

# Override list_themes to filter out rejected themes
list_themes() {
  list_themes_unfiltered | while IFS= read -r theme; do
    if ! is_theme_rejected "$theme"; then
      echo "$theme"
    fi
  done
}

# Override list_themes_with_status to filter out rejected themes and show display names
list_themes_with_status() {
  local current
  current=$(get_current_theme 2>/dev/null || echo "")

  list_themes | while IFS= read -r theme; do
    local display_info
    display_info=$(get_theme_display_info "$theme")
    if [[ "$theme" == "$current" ]]; then
      echo "‚óè $display_info (current)"
    else
      echo "  $display_info"
    fi
  done
}

# Override count_themes to use filtered list
count_themes() {
  list_themes | wc -l | xargs
}

#==============================================================================
# HELP
#==============================================================================

usage() {
  if command -v print_section &>/dev/null; then
    print_section "Theme Management" "yellow"

    print_section "Commands" "blue"
    cat <<'EOF'
  change               Interactive theme picker with color preview
  current              Show currently active theme
  list                 List available themes
  apply <theme>        Apply theme across all platform apps
  preview [theme]      Preview generated theme in tmux (fzf if no theme)
  random               Apply random theme
  like [message]       Like current theme with optional reason
  dislike [message]    Dislike current theme with optional reason
  note <message>       Add note to current theme (message required)
  rank                 Show themes ranked by likes/usage
  log                  View complete history
  info <theme>         Show theme details and app mappings
  reject <message>     Mark current theme as rejected (avoids rediscovery)
  rejected             List all rejected themes
  unreject             Restore a rejected theme (fzf picker with history)
  verify               Check theme system is working
  upgrade              Update theme to latest release
  generate-previews    Pre-generate all preview images
  clear-cache          Clear preview cache
EOF

    print_section "Subcommands" "blue"
    cat <<'EOF'
  background           Manage backgrounds (run for usage)
  opacity              Manage terminal opacity (run for usage)
  sync                 Manage GitHub Gist synchronization (run for usage)
EOF

    print_section "Examples" "yellow"
    echo "  $(print_cyan "theme change")                       # Interactive picker with preview"
    echo "  $(print_cyan "theme apply \"Rose Pine\"")            # Apply a theme"
    echo "  $(print_cyan "theme background rotate")            # New background, same theme"
    echo "  $(print_cyan "theme opacity set 90")               # Set opacity to 90%"
    echo "  $(print_cyan "theme sync init")                    # Initialize sync"

  else
    cat <<'EOF'
Theme Management
================

Commands
--------
  change               Interactive theme picker with color preview
  current              Show currently active theme
  list                 List available themes
  apply <theme>        Apply theme across all platform apps
  preview [theme]      Preview generated theme in tmux (fzf if no theme)
  random               Apply random theme
  like [message]       Like current theme with optional reason
  dislike [message]    Dislike current theme with optional reason
  note <message>       Add note to current theme (message required)
  rank                 Show themes ranked by likes/usage
  log                  View complete history
  info <theme>         Show theme details and app mappings
  reject <message>     Mark current theme as rejected (avoids rediscovery)
  rejected             List all rejected themes
  unreject             Restore a rejected theme (fzf picker with history)
  verify               Check theme system is working
  upgrade              Update theme to latest release
  generate-previews    Pre-generate all preview images
  clear-cache          Clear preview cache

Subcommands
-----------
  background           Manage backgrounds (run for usage)
  opacity              Manage terminal opacity (run for usage)
  sync                 Manage GitHub Gist synchronization (run for usage)

Examples
--------
  theme change                     # Interactive picker with preview
  theme apply "Rose Pine"          # Apply a theme
  theme background rotate          # New background, same theme
  theme opacity set 90             # Set opacity to 90%
  theme sync init                  # Initialize sync
EOF
  fi
}

#==============================================================================
# SUBCOMMAND USAGE FUNCTIONS
#==============================================================================

background_usage() {
  if command -v print_section &>/dev/null; then
    print_section "Background Management" "yellow"

    print_section "Commands" "blue"
    cat <<'EOF'
  current              Show current background
  rotate               Rotate to new background (keep theme)
  list                 List all available backgrounds
  like [note]          Like current background (for this theme)
  dislike [note]       Dislike current background (for this theme)
  reject <reason>      Reject background for this theme
  history              Show background history
  rank [--global]      Show background rankings
  pre-generate         Pre-generate all backgrounds (instant switching)
  cache-clear          Clear background cache
EOF

    print_section "Subcommands" "blue"
    cat <<'EOF'
  mode                 Manage background mode settings (run for usage)
  source               Manage source images (run for usage)
EOF

    print_section "Examples" "yellow"
    echo "  $(print_cyan "theme background current")           # Show current"
    echo "  $(print_cyan "theme background rotate")            # New background"
    echo "  $(print_cyan "theme background mode set recolor")  # Only recolor mode"
    echo "  $(print_cyan "theme background source add ~/pics") # Add source images"

  else
    cat <<'EOF'
Background Management
=====================

Commands
--------
  current              Show current background
  rotate               Rotate to new background (keep theme)
  list                 List all available backgrounds
  like [note]          Like current background (for this theme)
  dislike [note]       Dislike current background (for this theme)
  reject <reason>      Reject background for this theme
  history              Show background history
  rank [--global]      Show background rankings
  pre-generate         Pre-generate all backgrounds (instant switching)
  cache-clear          Clear background cache

Subcommands
-----------
  mode                 Manage background mode settings (run for usage)
  source               Manage source images (run for usage)

Examples
--------
  theme background current           # Show current
  theme background rotate            # New background
  theme background mode set recolor  # Only recolor mode
  theme background source add ~/pics # Add source images
EOF
  fi
}

background_mode_usage() {
  if command -v print_section &>/dev/null; then
    print_section "Background Mode Settings" "yellow"

    print_section "Commands" "blue"
    cat <<'EOF'
  current              Show currently enabled modes
  list                 Show all available modes
  set <modes...>       Set exact modes to use
  add <mode>           Add mode to current set
  remove <mode>        Remove mode from current set
  all                  Enable all modes (default)
EOF

    print_section "Available Modes" "blue"
    echo ""
    echo "Generated styles (no source image needed):"
    for style in "${BACKGROUND_GENERATED_STYLES[@]}"; do
      echo "  generated:$style"
    done
    echo ""
    echo "Source transforms (need source images):"
    echo "  recolor        - Recolor images with gowall"
    echo "  ascii          - Convert images to ASCII art"
    echo "  lowpoly        - Convert images to low-poly triangles"
    echo ""
    echo "Shortcuts:"
    echo "  generated      - All generated styles"
    echo "  all            - Everything (default)"

    print_section "Examples" "yellow"
    echo "  $(print_cyan "theme background mode current")"
    echo "  $(print_cyan "theme background mode set generated:plasma recolor")"
    echo "  $(print_cyan "theme background mode add ascii")"
    echo "  $(print_cyan "theme background mode remove lowpoly")"
    echo "  $(print_cyan "theme background mode all")"

  else
    cat <<'EOF'
Background Mode Settings
========================

Commands
--------
  current              Show currently enabled modes
  list                 Show all available modes
  set <modes...>       Set exact modes to use
  add <mode>           Add mode to current set
  remove <mode>        Remove mode from current set
  all                  Enable all modes (default)

Examples
--------
  theme background mode current
  theme background mode set generated:plasma recolor
  theme background mode add ascii
  theme background mode remove lowpoly
  theme background mode all
EOF
  fi
}

background_source_usage() {
  if command -v print_section &>/dev/null; then
    print_section "Background Source Images" "yellow"

    print_section "Commands" "blue"
    cat <<'EOF'
  list                 List configured sources
  add <path>           Add image or directory for recoloring
  remove <path>        Remove a source
  verify               Check for broken source paths
  clean                Remove broken source entries
EOF

    print_section "About Sources" "blue"
    echo "  Sources are path references (not copied). When using"
    echo "  'recolor' mode, gowall converts images to match your"
    echo "  current theme's color palette."

    print_section "Examples" "yellow"
    echo "  $(print_cyan "theme background source list")"
    echo "  $(print_cyan "theme background source add ~/Pictures/wallpapers")"
    echo "  $(print_cyan "theme background source add ~/photo.jpg")"
    echo "  $(print_cyan "theme background source verify")"

  else
    cat <<'EOF'
Background Source Images
========================

Commands
--------
  list                 List configured sources
  add <path>           Add image or directory for recoloring
  remove <path>        Remove a source
  verify               Check for broken source paths
  clean                Remove broken source entries

About Sources
-------------
  Sources are path references (not copied). When using
  'recolor' mode, gowall converts images to match your
  current theme's color palette.

Examples
--------
  theme background source list
  theme background source add ~/Pictures/wallpapers
  theme background source add ~/photo.jpg
  theme background source verify
EOF
  fi
}

opacity_usage() {
  if command -v print_section &>/dev/null; then
    print_section "Opacity Management" "yellow"

    print_section "Commands" "blue"
    cat <<'EOF'
  current              Show current opacity
  set <0-100>          Set opacity to specific value
  up                   Increase opacity by 5%
  down                 Decrease opacity by 5%
EOF

    print_section "Notes" "blue"
    echo "  Restart terminal to see changes."
    echo "  Value 100 = fully opaque, 0 = fully transparent."

    print_section "Examples" "yellow"
    echo "  $(print_cyan "theme opacity current")    # Show current"
    echo "  $(print_cyan "theme opacity set 90")     # Set to 90%"
    echo "  $(print_cyan "theme opacity up")         # Increase 5%"
    echo "  $(print_cyan "theme opacity down")       # Decrease 5%"

  else
    cat <<'EOF'
Opacity Management
==================

Commands
--------
  current              Show current opacity
  set <0-100>          Set opacity to specific value
  up                   Increase opacity by 5%
  down                 Decrease opacity by 5%

Notes
-----
  Restart terminal to see changes.
  Value 100 = fully opaque, 0 = fully transparent.

Examples
--------
  theme opacity current    # Show current
  theme opacity set 90     # Set to 90%
  theme opacity up         # Increase 5%
  theme opacity down       # Decrease 5%
EOF
  fi
}

sync_usage() {
  if command -v print_section &>/dev/null; then
    print_section "Sync Management" "yellow"

    print_section "Commands" "blue"
    cat <<'EOF'
  status               Show sync status
  init                 Initialize sync (creates GitHub Gist)
  push                 Manual push to remote
  pull                 Manual pull from remote
  on                   Enable automatic sync
  off                  Disable automatic sync
EOF

    print_section "Examples" "yellow"
    echo "  $(print_cyan "theme sync status")   # Check sync state"
    echo "  $(print_cyan "theme sync init")     # Set up sync"
    echo "  $(print_cyan "theme sync push")     # Force push"
    echo "  $(print_cyan "theme sync pull")     # Force pull"

  else
    cat <<'EOF'
Sync Management
===============

Commands
--------
  status               Show sync status
  init                 Initialize sync (creates GitHub Gist)
  push                 Manual push to remote
  pull                 Manual pull from remote
  on                   Enable automatic sync
  off                  Disable automatic sync

Examples
--------
  theme sync status   # Check sync state
  theme sync init     # Set up sync
  theme sync push     # Force push
  theme sync pull     # Force pull
EOF
  fi
}

#==============================================================================
# THEME OPERATIONS
#==============================================================================

show_current() {
  sync_before_read
  local current
  current=$(get_current_theme)

  if [[ -z "$current" ]]; then
    echo "No theme currently applied"
    return
  fi

  local display_info
  display_info=$(get_theme_display_info "$current")

  echo ""
  echo "Current Theme: $display_info"
  echo "            ID: $current"
  echo ""

  local stats
  stats=$(get_theme_stats "$current" 2>/dev/null || echo "{}")

  if [[ -n "$stats" ]] && [[ "$stats" != "{}" ]] && [[ "$stats" != "null" ]]; then
    local score likes dislikes notes applies
    score=$(echo "$stats" | jq -r '.score // 0')
    likes=$(echo "$stats" | jq -r '.likes // 0')
    dislikes=$(echo "$stats" | jq -r '.dislikes // 0')
    notes=$(echo "$stats" | jq -r '.notes // 0')
    applies=$(echo "$stats" | jq -r '.applies // 0')

    printf "Score: %+d (%d likes, %d dislikes)\n" "$score" "$likes" "$dislikes"
    printf "Notes: %d | Times applied: %d\n" "$notes" "$applies"
  fi

  local base16
  base16=$(get_theme_mapping "$current" "base16" 2>/dev/null || echo "")
  local ghostty
  ghostty=$(get_theme_mapping "$current" "ghostty" 2>/dev/null || echo "")

  echo ""
  echo "App mappings:"
  [[ -n "$base16" ]] && echo "  Base16: $base16"
  [[ -n "$ghostty" ]] && echo "  Ghostty: $ghostty"
}

show_list() {
  local platform
  platform=$(detect_platform)

  if command -v print_blue &>/dev/null; then
    print_blue "Available Themes ($(count_themes) total)"
  else
    echo "Available Themes ($(count_themes) total)"
  fi
  echo ""

  list_themes_with_status

  echo ""
  echo "Apply with: theme apply <name>"
}

apply_theme() {
  local theme_input="$1"

  if [[ -z "$theme_input" ]]; then
    echo "Error: Theme name required"
    echo "Usage: theme apply <theme-name>"
    echo ""
    echo "Available themes:"
    list_themes | head -10
    exit 1
  fi

  local canonical
  canonical=$(theme_name_to_canonical "$theme_input")

  # Check if theme is in library
  local lib_path
  lib_path=$(get_library_path "$canonical")

  local display_info
  display_info=$(get_theme_display_info "$canonical")

  echo "Applying theme: $display_info"
  if [[ -z "$lib_path" ]]; then
    echo "  (not in library - limited app support)"
  fi
  echo ""

  # Apply to all apps
  local result
  result=$(apply_theme_to_apps "$canonical")

  local applied
  applied=$(echo "$result" | grep "^APPLIED:" | cut -d: -f2)
  local background_id
  background_id=$(echo "$result" | grep "^BACKGROUND:" | cut -d: -f2-)

  # Reload applicable apps
  reload_apps "$applied"

  # Log the theme action
  log_action "apply" "$canonical"

  # Log the background action if one was applied
  if [[ -n "$background_id" ]] && [[ "$background_id" != "none" ]]; then
    log_background_action "apply" "$background_id" "$canonical"
  fi

  sync_after_action

  echo ""
  echo "Theme applied."
}

apply_random() {
  local themes
  mapfile -t themes < <(list_themes)

  if [[ ${#themes[@]} -eq 0 ]]; then
    echo "Error: No themes found"
    exit 1
  fi

  # Get apply counts for all themes
  declare -A apply_counts
  while IFS=$'\t' read -r theme count; do
    apply_counts["$theme"]=$count
  done < <(get_all_apply_counts)

  # Find minimum apply count among available themes
  local min_count=999999
  for theme in "${themes[@]}"; do
    local count="${apply_counts[$theme]:-0}"
    if [[ $count -lt $min_count ]]; then
      min_count=$count
    fi
  done

  # Get all themes with minimum apply count
  local least_used=()
  for theme in "${themes[@]}"; do
    local count="${apply_counts[$theme]:-0}"
    if [[ $count -eq $min_count ]]; then
      least_used+=("$theme")
    fi
  done

  # Pick randomly from least-used themes
  local random_theme="${least_used[$RANDOM % ${#least_used[@]}]}"

  local display_info
  display_info=$(get_theme_display_info "$random_theme")
  echo "üé≤ Randomly selected: $display_info"
  echo "   (${#least_used[@]} themes with $min_count applies)"
  echo ""
  apply_theme "$random_theme"
}

change_theme() {
  if ! command -v fzf &>/dev/null; then
    echo "Error: fzf not found. Install with: brew install fzf"
    exit 1
  fi

  if ! command -v magick &>/dev/null; then
    echo "Error: ImageMagick not found. Install with: brew install imagemagick"
    exit 1
  fi

  if ! command -v chafa &>/dev/null && ! command -v viu &>/dev/null; then
    echo "Note: Install 'chafa' or 'viu' for image preview support"
    echo "  brew install chafa"
    echo ""
    echo "Continuing with text-based preview..."
    sleep 2
  fi

  mkdir -p "$PREVIEW_CACHE_DIR"

  local preview_script="/tmp/theme-fzf-preview-$$.sh"
  local preview_log="/tmp/theme-preview-debug.log"
  cat >"$preview_script" <<PREVIEW_EOF
#!/bin/bash
exec 2>>"$preview_log"
echo "=== Preview for: \$1 ===" >>"$preview_log"

if ! source "$THEME_APP_DIR/lib/lib.sh" 2>>"$preview_log"; then
  echo "ERROR: Failed to source lib.sh"
  exit 1
fi

theme="\$1"

if [[ -n "\${TMUX:-}" ]]; then
  display_theme_details "\$theme" "full"
  echo ""
  echo "Graphics preview not available in tmux."
  echo "Open a regular terminal window to see theme preview."
elif preview_file=\$(get_or_generate_preview "\$theme" 2>>"$preview_log"); then
  echo "Preview file: \$preview_file" >>"$preview_log"
  display_theme_details "\$theme" "compact"
  echo ""
  if command -v chafa &>/dev/null; then
    chafa -f kitty --speed 10 --dither none "\$preview_file" 2>>"$preview_log" || echo "Preview: \$theme"
  elif command -v viu &>/dev/null; then
    viu -w 80 "\$preview_file" 2>>"$preview_log" || echo "Preview: \$theme"
  else
    echo "(Install chafa or viu for image preview)"
    display_theme_details "\$theme" "full"
  fi
else
  echo "Failed to generate preview"
  display_theme_details "\$theme" "full"
fi
PREVIEW_EOF

  chmod +x "$preview_script"

  # Build list with display names and IDs (tab-separated)
  local theme_list=""
  while IFS= read -r theme_id; do
    local display_info
    display_info=$(get_theme_display_info "$theme_id")
    theme_list+="${display_info}"$'\t'"${theme_id}"$'\n'
  done < <(list_themes)

  local selected
  selected=$(echo -n "$theme_list" | fzf \
    --prompt="Select theme > " \
    --height=100% \
    --delimiter=$'\t' \
    --with-nth=1 \
    --preview="$preview_script {2}" \
    --preview-window=right:60%)

  rm -f "$preview_script"

  if [[ -n "$selected" ]]; then
    # Extract the theme ID (second field)
    local theme_id
    theme_id=$(echo "$selected" | cut -f2)
    apply_theme "$theme_id"
  fi
}

mark_liked() {
  local message="$*"
  local theme
  theme=$(get_current_theme)

  if [[ -z "$theme" ]]; then
    echo "Error: No theme currently applied"
    exit 1
  fi

  local display_info
  display_info=$(get_theme_display_info "$theme")

  log_action "like" "$theme" "$message"
  sync_after_action
  echo "Liked: $display_info"
  [[ -n "$message" ]] && echo "  Reason: $message"
}

mark_disliked() {
  local message="$*"
  local theme
  theme=$(get_current_theme)

  if [[ -z "$theme" ]]; then
    echo "Error: No theme currently applied"
    exit 1
  fi

  local display_info
  display_info=$(get_theme_display_info "$theme")

  log_action "dislike" "$theme" "$message"
  sync_after_action
  echo "Disliked: $display_info"
  [[ -n "$message" ]] && echo "  Reason: $message"
}

add_note() {
  local message="$*"
  local theme
  theme=$(get_current_theme)

  if [[ -z "$theme" ]]; then
    echo "Error: No theme currently applied"
    exit 1
  fi

  if [[ -z "$message" ]]; then
    echo "Error: Note message required"
    echo "Usage: theme note <message>"
    exit 1
  fi

  local display_info
  display_info=$(get_theme_display_info "$theme")

  log_action "note" "$theme" "$message"
  sync_after_action
  echo "Added note to: $display_info"
  echo "  Note: $message"
}

mark_rejected() {
  local reason="$*"
  local theme
  theme=$(get_current_theme)

  if [[ -z "$theme" ]]; then
    echo "Error: No theme currently applied"
    exit 1
  fi

  if [[ -z "$reason" ]]; then
    echo "Error: Rejection reason required"
    echo "Usage: theme reject <message>"
    exit 1
  fi

  local display_info
  display_info=$(get_theme_display_info "$theme")

  reject_theme "$theme" "$reason"
  sync_after_action
  echo "Marked as rejected: $display_info"
  echo "  Reason: $reason"
  echo ""
  echo "This theme will be tracked to avoid rediscovery."
}

show_rejected() {
  local rejected
  rejected=$(list_rejected_themes)

  if [[ -z "$rejected" ]] || [[ "$rejected" == "[]" ]]; then
    echo "No rejected themes yet."
    echo ""
    echo "When you try a theme and don't like it, mark it as rejected:"
    echo "  theme reject \"reason\""
    return
  fi

  echo ""
  echo "Rejected Themes"
  echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
  echo ""

  local count=0
  while IFS= read -r line; do
    count=$((count + 1))
    local theme rejected_date reason platforms
    theme=$(echo "$line" | jq -r '.theme')
    rejected_date=$(echo "$line" | jq -r '.rejected_date')
    reason=$(echo "$line" | jq -r '.reason')
    platforms=$(echo "$line" | jq -r '.platforms')

    local display_info
    display_info=$(get_theme_display_info "$theme")

    local date_formatted
    if date --version &>/dev/null 2>&1; then
      date_formatted=$(date -d "$rejected_date" +"%Y-%m-%d" 2>/dev/null || echo "$rejected_date")
    else
      date_formatted=$(date -j -f "%Y-%m-%dT%H:%M:%S" "${rejected_date:0:19}" +"%Y-%m-%d" 2>/dev/null || echo "$rejected_date")
    fi

    echo "$count. $display_info"
    echo "   ID: $theme"
    echo "   Rejected: $date_formatted"
    echo "   Reason: $reason"
    [[ -n "$platforms" ]] && echo "   Platforms: $platforms"
    echo ""
  done < <(echo "$rejected")

  echo "Total rejected: $count"
  echo ""
}

unreject_theme_interactive() {
  if ! command -v fzf &>/dev/null; then
    echo "Error: fzf not found. Install with: brew install fzf"
    exit 1
  fi

  local rejected
  rejected=$(list_rejected_themes)

  if [[ -z "$rejected" ]] || [[ "$rejected" == "[]" ]]; then
    echo "No rejected themes to unreject."
    return
  fi

  local theme_ids
  theme_ids=$(echo "$rejected" | jq -r '.theme')

  if [[ -z "$theme_ids" ]]; then
    echo "No rejected themes to unreject."
    return
  fi

  # Build list with display names and IDs (tab-separated)
  local theme_list=""
  while IFS= read -r theme_id; do
    local display_info
    display_info=$(get_theme_display_info "$theme_id")
    theme_list+="${display_info}"$'\t'"${theme_id}"$'\n'
  done <<<"$theme_ids"

  local preview_script="/tmp/theme-unreject-preview-$$.sh"
  cat >"$preview_script" <<'PREVIEW_EOF'
#!/bin/bash
theme="$1"
THEME_APP_DIR="$2"

source "$THEME_APP_DIR/lib/storage.sh"

echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "Theme: $theme"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""

echo "REJECTION INFO:"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
rejection_info=$(get_rejected_theme_info "$theme")
if [[ -n "$rejection_info" ]] && [[ "$rejection_info" != "{}" ]]; then
  rejected_date=$(echo "$rejection_info" | jq -r '.ts // "unknown"')
  reason=$(echo "$rejection_info" | jq -r '.message // "No reason"')
  machine=$(echo "$rejection_info" | jq -r '.machine // .platform // "unknown"')
  echo "  Date: $rejected_date"
  echo "  Reason: $reason"
  echo "  Machine: $machine"
else
  echo "  No rejection info found"
fi
echo ""

echo "FULL HISTORY:"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
history=$(get_history | jq -c --arg theme "$theme" '.[] | select(.theme == $theme)')
if [[ -n "$history" ]]; then
  echo "$history" | while IFS= read -r line; do
    ts=$(echo "$line" | jq -r '.ts')
    action=$(echo "$line" | jq -r '.action')
    machine=$(echo "$line" | jq -r '.machine // .platform')
    message=$(echo "$line" | jq -r '.message // empty')

    date_part="${ts:0:10}"

    if [[ -n "$message" ]]; then
      printf "  %s | %-8s | %s | %s\n" "$date_part" "$action" "$machine" "$message"
    else
      printf "  %s | %-8s | %s\n" "$date_part" "$action" "$machine"
    fi
  done
else
  echo "  No history found"
fi
echo ""

echo "STATS SUMMARY:"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
stats=$(get_theme_stats "$theme" 2>/dev/null)
if [[ -n "$stats" ]] && [[ "$stats" != "null" ]]; then
  likes=$(echo "$stats" | jq -r '.likes // 0')
  dislikes=$(echo "$stats" | jq -r '.dislikes // 0')
  applies=$(echo "$stats" | jq -r '.applies // 0')
  score=$(echo "$stats" | jq -r '.score // 0')
  printf "  Score: %+d (%d likes, %d dislikes)\n" "$score" "$likes" "$dislikes"
  echo "  Times applied: $applies"
else
  echo "  No stats available"
fi
PREVIEW_EOF

  chmod +x "$preview_script"

  local selected
  selected=$(echo -n "$theme_list" | fzf \
    --prompt="Select theme to unreject > " \
    --height=80% \
    --delimiter=$'\t' \
    --with-nth=1 \
    --preview="$preview_script {2} '$THEME_APP_DIR'" \
    --preview-window=right:60%)

  rm -f "$preview_script"

  if [[ -n "$selected" ]]; then
    # Extract the theme ID (second field)
    local theme_id display_info
    theme_id=$(echo "$selected" | cut -f2)
    display_info=$(echo "$selected" | cut -f1)

    unreject_theme "$theme_id"
    sync_after_action
    echo "Unrejected: $display_info"
    echo ""
    echo "This theme is now available in the theme list again."
  fi
}

show_rankings() {
  sync_before_read
  local rankings
  rankings=$(get_rankings)

  if [[ -z "$rankings" ]] || [[ "$rankings" == "null" ]]; then
    echo "No theme data yet. Start using themes!"
    return
  fi

  echo ""
  echo "Theme Rankings (by score and usage)"
  echo ""

  local rank=0
  while IFS= read -r line; do
    rank=$((rank + 1))
    local theme score likes dislikes last_used platforms usage_seconds
    theme=$(echo "$line" | jq -r '.theme')
    score=$(echo "$line" | jq -r '.score')
    likes=$(echo "$line" | jq -r '.likes')
    dislikes=$(echo "$line" | jq -r '.dislikes')
    last_used=$(echo "$line" | jq -r '.last_used')
    platforms=$(echo "$line" | jq -r '.platforms')
    usage_seconds=$(echo "$line" | jq -r '.usage_seconds // 0')

    local display_info
    display_info=$(get_theme_display_info "$theme")

    if [[ "$last_used" == "never" ]]; then
      last_used="never used"
    else
      last_used=$(date -d "$last_used" "+%b %d, %Y" 2>/dev/null || echo "$last_used")
    fi

    local usage_time="not used"
    if [[ "$usage_seconds" -gt 0 ]]; then
      usage_time=$(format_duration "$usage_seconds")
    fi

    printf "%2d. %s\n" "$rank" "$display_info"
    printf "    Score: %+d (%d likes, %d dislikes)\n" "$score" "$likes" "$dislikes"
    printf "    Usage time: %s\n" "$usage_time"
    printf "    Last used: %s\n" "$last_used"
    [[ -n "$platforms" ]] && printf "    Platforms: %s\n" "$platforms"
    echo ""
  done <<<"$rankings"
}

show_log() {
  sync_before_read
  local history
  history=$(get_history_raw)

  if [[ -z "$history" ]]; then
    echo "No history yet. Start using themes!"
    return
  fi

  echo ""
  echo "Theme History Log"
  echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
  echo ""

  echo "Data file: $THEME_HISTORY_FILE"
  if [[ -f "$THEME_HISTORY_FILE" ]]; then
    local count
    count=$(wc -l <"$THEME_HISTORY_FILE" | xargs)
    echo "  $count entries"
  fi
  echo ""

  if command -v bat &>/dev/null; then
    echo "$history" | jq -r '
      "\(.ts) | \(.machine // .platform) | \(.action) | \(.theme)" +
      (if .message then " | \(.message)" else "" end)
    ' | bat --plain --language=log --theme=base16
  else
    echo "$history" | jq -r '
      "\(.ts) | \(.machine // .platform) | \(.action) | \(.theme)" +
      (if .message then " | \(.message)" else "" end)
    '
  fi
}

show_info() {
  local theme_input="$1"

  if [[ -z "$theme_input" ]]; then
    echo "Error: Theme name required"
    echo "Usage: theme info <theme-name>"
    exit 1
  fi

  local canonical
  canonical=$(theme_name_to_canonical "$theme_input")

  local theme_data
  theme_data=$(get_theme_by_name "$canonical")

  if [[ -z "$theme_data" ]] || [[ "$theme_data" == "null" ]]; then
    echo "Theme not found: $theme_input"
    echo ""
    echo "Available themes:"
    list_themes | head -10
    exit 1
  fi

  local display_info
  display_info=$(get_theme_display_info "$canonical")

  echo ""
  echo "Theme: $display_info"
  echo "    ID: $canonical"
  echo ""

  echo "App Mappings:"
  local ghostty kitty neovim base16 windows
  ghostty=$(echo "$theme_data" | yq -r '.ghostty // "not available"')
  kitty=$(echo "$theme_data" | yq -r '.kitty // "not available"')
  neovim=$(echo "$theme_data" | yq -r '.neovim // "not available"')
  base16=$(echo "$theme_data" | yq -r '.base16 // "not available"')
  windows=$(echo "$theme_data" | yq -r '.windows_terminal // "not available"')

  echo "  Ghostty: $ghostty"
  echo "  Kitty: $kitty"
  echo "  Neovim: $neovim"
  echo "  Base16: $base16"
  echo "  Windows Terminal: $windows"

  local tags
  tags=$(echo "$theme_data" | yq -r '.tags | join(", ") // "none"')
  echo ""
  echo "Tags: $tags"

  local stats
  stats=$(get_theme_stats "$canonical" 2>/dev/null || echo "{}")

  if [[ -n "$stats" ]] && [[ "$stats" != "{}" ]] && [[ "$stats" != "null" ]]; then
    local score likes dislikes applies
    score=$(echo "$stats" | jq -r '.score // 0')
    likes=$(echo "$stats" | jq -r '.likes // 0')
    dislikes=$(echo "$stats" | jq -r '.dislikes // 0')
    applies=$(echo "$stats" | jq -r '.applies // 0')

    echo ""
    echo "Your Stats:"
    printf "  Score: %+d (%d likes, %d dislikes)\n" "$score" "$likes" "$dislikes"
    printf "  Times applied: %d\n" "$applies"
  fi
}

verify_system() {
  echo "Verifying theme system..."
  echo ""

  local errors=0

  # Check themes directory
  if [[ -d "$THEMES_DIR" ]]; then
    local count
    count=$(count_themes)
    echo "  Themes directory: $count themes available"
  else
    echo "  ERROR: Themes directory not found: $THEMES_DIR"
    errors=$((errors + 1))
  fi

  # Check yq
  if command -v yq &>/dev/null; then
    echo "  yq: installed"
  else
    echo "  ERROR: yq not installed"
    errors=$((errors + 1))
  fi

  # Check current theme
  local current
  current=$(get_current_theme 2>/dev/null || echo "")
  if [[ -n "$current" ]]; then
    local display_info
    display_info=$(get_theme_display_info "$current")
    echo "  Current theme: $display_info"
    echo "    ID: $current"
    local theme_path
    theme_path=$(get_theme_path "$current")
    if [[ -n "$theme_path" ]]; then
      local configs=""
      for f in "$theme_path"/*.{conf,theme,css}; do
        [[ -f "$f" ]] && configs+="$(basename "$f") "
      done
      echo "    Generated configs: $configs"
    fi
  else
    echo "  Current theme: none applied"
  fi

  # Platform
  local platform
  platform=$(detect_platform)
  echo "  Platform: $platform"

  echo ""
  if [[ $errors -eq 0 ]]; then
    echo "System ready!"
  else
    echo "Found $errors error(s). Run: task symlinks:link"
  fi
}

#==============================================================================
# PREVIEW
#==============================================================================

GENERATED_THEMES_DIR="$THEME_APP_DIR/themes"
DEMO_DIR="$THEME_APP_DIR/demo"
GHOSTTY_THEME="${HOME}/.config/ghostty/themes/current.conf"
BTOP_THEME="${HOME}/.config/btop/themes/current.theme"
TMUX_THEME="${HOME}/.config/tmux/themes/current.conf"

list_generated_themes() {
  for dir in "$GENERATED_THEMES_DIR"/*/; do
    [[ -d "$dir" ]] && basename "$dir"
  done
}

select_generated_theme() {
  if command -v fzf &>/dev/null; then
    list_generated_themes | fzf --prompt="Select theme to preview: "
  else
    local themes
    mapfile -t themes < <(list_generated_themes)
    select theme in "${themes[@]}"; do
      [[ -n "$theme" ]] && echo "$theme" && break
    done
  fi
}

apply_preview_themes() {
  local theme_name="$1"
  local theme_path="$GENERATED_THEMES_DIR/$theme_name"

  # Ghostty
  if [[ -f "$theme_path/ghostty.conf" ]]; then
    cp "$theme_path/ghostty.conf" "$GHOSTTY_THEME"
    echo "  Applied: ghostty"
  fi

  # btop
  if [[ -f "$theme_path/btop.theme" ]]; then
    mkdir -p "$(dirname "$BTOP_THEME")"
    cp "$theme_path/btop.theme" "$BTOP_THEME"
    echo "  Applied: btop"
  fi

  # tmux
  if [[ -f "$theme_path/tmux.conf" ]]; then
    mkdir -p "$(dirname "$TMUX_THEME")"
    cp "$theme_path/tmux.conf" "$TMUX_THEME"
    tmux source-file "$TMUX_THEME" 2>/dev/null || true
    echo "  Applied: tmux"
  fi
}

create_preview_window() {
  local theme_name="$1"
  local window_name="preview-$theme_name"
  local theme_path="$GENERATED_THEMES_DIR/$theme_name"

  # Get neovim colorscheme from theme.yml (defaults to theme_name if not specified)
  local nvim_colorscheme="$theme_name"
  if [[ -f "$theme_path/theme.yml" ]]; then
    local yml_colorscheme
    yml_colorscheme=$(yq -r '.meta.neovim_colorscheme // empty' "$theme_path/theme.yml" 2>/dev/null || true)
    if [[ -n "$yml_colorscheme" ]]; then
      nvim_colorscheme="$yml_colorscheme"
    fi
  fi

  # Create new window in current session
  tmux new-window -n "$window_name" -c "$DEMO_DIR"

  # Left: neovim with sample code
  tmux send-keys "nvim -c 'colorscheme $nvim_colorscheme' sample.py" Enter

  # Split right 40%
  tmux split-window -h -p 40 -c "$HOME/dotfiles"

  # Right top: btop
  tmux send-keys "btop" Enter

  # Split bottom right 50%
  tmux split-window -v -p 50 -c "$HOME/dotfiles"

  # Bottom right: git status + ls
  tmux send-keys "echo '=== $theme_name ===' && echo '' && git status --short && echo '' && ls --color=always" Enter

  # Focus neovim pane
  tmux select-pane -L
}

show_preview() {
  local theme_name="${1:-}"

  # Select theme if not provided
  if [[ -z "$theme_name" ]]; then
    theme_name=$(select_generated_theme)
    [[ -z "$theme_name" ]] && return 0
  fi

  # Verify theme exists
  if [[ ! -d "$GENERATED_THEMES_DIR/$theme_name" ]]; then
    echo "Error: Theme not found: $theme_name"
    echo "Available themes:"
    list_generated_themes | sed 's/^/  /'
    return 1
  fi

  echo "Preview: $theme_name"
  apply_preview_themes "$theme_name"
  echo ""
  echo "Reload Ghostty: Cmd+Shift+,"
  echo "Close preview window: prefix+& or :q in vim, q in btop, exit in shell"
  echo ""

  if [[ -n "${TMUX:-}" ]]; then
    create_preview_window "$theme_name"
  else
    echo "Error: Must be in tmux to create preview window"
    return 1
  fi
}

generate_all_previews() {
  echo "Pre-generating all theme previews..."
  echo "This will take a few minutes but makes browsing instant."
  echo ""

  if ! command -v magick &>/dev/null; then
    echo "Error: ImageMagick not found. Install with: brew install imagemagick"
    exit 1
  fi

  mkdir -p "$PREVIEW_CACHE_DIR"

  local themes
  themes=$(list_themes)
  local total
  total=$(echo "$themes" | wc -l | xargs)
  local current=0

  while IFS= read -r theme; do
    current=$((current + 1))
    printf "[%d/%d] Generating preview for: %s\n" "$current" "$total" "$theme"

    local cache_file
    cache_file=$(get_cached_preview_path "$theme")

    if [[ -f "$cache_file" ]] && validate_preview_image "$cache_file" &>/dev/null; then
      echo "  ‚úì Already exists"
      continue
    fi

    if generate_theme_preview "$theme" "$cache_file" 2>/dev/null; then
      echo "  ‚úì Generated"
    else
      echo "  ‚úó Failed"
    fi
  done <<<"$themes"

  echo ""
  echo "‚úì All previews generated!"
  echo "  Cache location: $PREVIEW_CACHE_DIR"
  echo "  Run 'theme change' for instant browsing"
}

#==============================================================================
# BACKGROUND CACHE
#==============================================================================

generate_all_backgrounds() {
  echo "Pre-generating all theme backgrounds..."
  echo "This will take a while but makes theme switching instant."
  echo ""

  if ! command -v magick &>/dev/null; then
    echo "Error: ImageMagick not found. Install with: brew install imagemagick"
    exit 1
  fi

  local styles=("plasma" "geometric" "hexagons" "circles" "swirl" "spotlight" "sphere" "spheres")
  local generator_script="$THEME_APP_DIR/lib/generators/background.sh"

  if [[ ! -f "$generator_script" ]]; then
    echo "Error: Background generator not found"
    exit 1
  fi

  local themes
  themes=$(list_themes)
  local total
  total=$(echo "$themes" | wc -l | xargs)
  local current=0

  while IFS= read -r theme; do
    current=$((current + 1))
    local lib_path
    lib_path=$(get_library_path "$theme")

    if [[ -z "$lib_path" ]] || [[ ! -f "$lib_path/theme.yml" ]]; then
      printf "[%d/%d] %s - skipped (no theme.yml)\n" "$current" "$total" "$theme"
      continue
    fi

    printf "[%d/%d] %s\n" "$current" "$total" "$theme"

    local cache_dir="$BACKGROUND_CACHE_DIR/$theme"
    mkdir -p "$cache_dir"

    for style in "${styles[@]}"; do
      local cache_file="$cache_dir/${style}.png"

      if [[ -f "$cache_file" ]]; then
        printf "  %-10s ‚úì exists\n" "$style"
        continue
      fi

      if bash "$generator_script" "$lib_path/theme.yml" "$cache_file" "$style" 1920 1080 2>/dev/null; then
        printf "  %-10s ‚úì generated\n" "$style"
      else
        printf "  %-10s ‚úó failed\n" "$style"
      fi
    done
  done <<<"$themes"

  echo ""
  echo "‚úì All backgrounds generated!"
  echo "  Cache location: $BACKGROUND_CACHE_DIR"
  local size
  size=$(du -sh "$BACKGROUND_CACHE_DIR" 2>/dev/null | cut -f1)
  echo "  Cache size: $size"
}

clear_background_cache() {
  if [[ -d "$BACKGROUND_CACHE_DIR" ]]; then
    local size
    size=$(du -sh "$BACKGROUND_CACHE_DIR" 2>/dev/null | cut -f1)
    rm -rf "$BACKGROUND_CACHE_DIR"
    echo "‚úì Cleared background cache ($size)"
  else
    echo "Background cache is empty"
  fi
}

#==============================================================================
# MAIN
#==============================================================================

main() {
  case "${1:-}" in
  change)
    change_theme
    ;;
  preview)
    show_preview "${2:-}"
    ;;
  current)
    show_current
    ;;
  list | ls)
    show_list
    ;;
  apply)
    apply_theme "${2:-}"
    ;;
  random | rand)
    apply_random
    ;;
  like)
    mark_liked "${@:2}"
    ;;
  dislike)
    mark_disliked "${@:2}"
    ;;
  note)
    add_note "${@:2}"
    ;;
  rank | ranks | ranking)
    show_rankings
    ;;
  log | history)
    show_log
    ;;
  info)
    show_info "${2:-}"
    ;;
  reject)
    mark_rejected "${@:2}"
    ;;
  rejected)
    show_rejected
    ;;
  unreject)
    unreject_theme_interactive
    ;;
  verify)
    verify_system
    ;;
  upgrade | update)
    local before_version latest_tag
    before_version=$(git -C "$THEME_APP_DIR" describe --tags --always 2>/dev/null)

    git -C "$THEME_APP_DIR" fetch --tags --quiet 2>/dev/null
    latest_tag=$(git -C "$THEME_APP_DIR" tag -l 'v*' --sort=-v:refname | head -n1)

    if [[ -z "$latest_tag" ]]; then
      echo "‚úó no releases found" >&2
      exit 1
    fi

    if [[ "$before_version" == "$latest_tag" ]]; then
      echo "‚úì theme already at latest: $latest_tag"
      exit 0
    fi

    git -C "$THEME_APP_DIR" checkout --quiet "$latest_tag"
    echo "‚úì theme upgraded: $before_version ‚Üí $latest_tag"
    ;;
  opacity)
    case "${2:-}" in
      "" | --help | -h)
        opacity_usage
        ;;
      current)
        echo "Background opacity: $(get_current_opacity)"
        ;;
      up)
        if result=$(change_opacity 0.05); then
          echo "Opacity: $result"
          echo ""
          echo "Restart terminal to see changes."
        fi
        ;;
      down)
        if result=$(change_opacity -0.05); then
          echo "Opacity: $result"
          echo ""
          echo "Restart terminal to see changes."
        fi
        ;;
      set)
        if [[ -z "${3:-}" ]]; then
          echo "Error: opacity value required" >&2
          echo "Usage: theme opacity set <0-100>" >&2
          exit 1
        fi
        if result=$(set_opacity "$3"); then
          echo "Opacity: $result"
          echo ""
          echo "Restart terminal to see changes."
        fi
        ;;
      *)
        echo "Unknown opacity command: ${2:-}" >&2
        echo "Usage: theme opacity [current|set|up|down]" >&2
        exit 1
        ;;
    esac
    ;;
  generate-previews)
    generate_all_previews
    ;;
  clear-cache)
    clear_preview_cache
    ;;
  background)
    case "${2:-}" in
    "" | --help | -h)
      background_usage
      ;;
    current)
      # Show current background info
      local current_bg current_theme
      current_bg=$(get_current_background)
      current_theme=$(get_current_theme)

      if [[ -z "$current_bg" ]]; then
        echo "No background tracked yet."
        echo ""
        echo "Apply a theme to set background: theme apply <name>"
      else
        echo ""
        echo "Current Background"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        local bg_type="${current_bg%%:*}"
        local bg_value="${current_bg#*:}"
        echo "  Type: $bg_type"
        if [[ "$bg_type" == "recolor" ]]; then
          echo "  Source: $bg_value"
          echo "  File: $(basename "$bg_value")"
        else
          echo "  Style: $bg_value"
        fi
        echo "  Theme: $current_theme"
        echo ""
        echo "Rotate background: theme background rotate"
      fi
      ;;
    rotate)
      local platform
      platform=$(detect_platform)
      if [[ "$platform" != "macos" ]]; then
        echo "Error: Background rotation only supported on macOS" >&2
        exit 1
      fi

      echo "Rotating background..."

      # Get current theme for filtering
      local current_theme
      current_theme=$(get_current_theme)

      # Get rejected backgrounds and weights for this theme
      local rejected_list weights_json
      rejected_list=$(get_rejected_background_ids "$current_theme")
      weights_json=$(compute_background_weights "$current_theme")

      local new_style
      if new_style=$(rotate_background "$rejected_list" "$weights_json"); then
        echo "  ‚úì background ($new_style)"
        # Log the background action
        local background_id
        background_id=$(get_current_background)
        log_background_action "apply" "$background_id" "$current_theme"
        sync_after_action
      else
        echo "  ‚úó background rotation failed" >&2
        exit 1
      fi
      ;;
    list)
      local filter="${3:-}"
      echo ""
      echo "Available Backgrounds"
      echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      echo ""

      local current_mode
      current_mode=$(get_background_mode)
      echo "Mode: $current_mode"
      echo ""

      if [[ "$filter" != "--recolor" ]]; then
        echo "Generated Styles:"
        for style in "${BACKGROUND_GENERATED_STYLES[@]}"; do
          local enabled=""
          if is_background_type_enabled "generated:$style"; then
            enabled="‚úì"
          else
            enabled="‚úó"
          fi
          echo "  [$enabled] generated:$style"
        done
        echo ""
      fi

      if [[ "$filter" != "--generated" ]]; then
        echo "Source Transforms:"
        for source_type in "${BACKGROUND_SOURCE_TYPES[@]}"; do
          local type_enabled=""
          if is_source_type_enabled "$source_type"; then
            type_enabled="‚úì"
          else
            type_enabled="‚úó"
          fi
          echo "  [$type_enabled] $source_type"
        done

        local images
        images=$(get_all_background_images)
        if [[ -n "$images" ]]; then
          local img_count
          img_count=$(echo "$images" | wc -l | xargs)
          echo ""
          echo "  $img_count source images available:"
          echo "$images" | head -10 | while IFS= read -r img; do
            echo "    - $(basename "$img")"
          done
          if [[ $img_count -gt 10 ]]; then
            echo "    ... and $((img_count - 10)) more"
          fi
        else
          echo ""
          echo "  No source images configured"
          echo "  Add with: theme background source add <path>"
        fi
        echo ""
      fi

      local total_count
      total_count=$(get_enabled_generated_styles | wc -l | xargs)
      local img_count
      img_count=$(get_all_background_images | wc -l | xargs)
      for source_type in "${BACKGROUND_SOURCE_TYPES[@]}"; do
        if is_source_type_enabled "$source_type"; then
          total_count=$((total_count + img_count))
        fi
      done
      echo "Total enabled: $total_count backgrounds"
      ;;
    mode)
      case "${3:-}" in
      "" | --help | -h)
        background_mode_usage
        ;;
      list)
        echo ""
        echo "Available Background Modes"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo ""
        echo "Generated styles (no source image needed):"
        for style in "${BACKGROUND_GENERATED_STYLES[@]}"; do
          echo "  generated:$style"
        done
        echo ""
        echo "Source transforms (need source images):"
        echo "  recolor        - Recolor images with gowall"
        echo "  ascii          - Convert images to ASCII art"
        echo "  lowpoly        - Convert images to low-poly triangles"
        echo ""
        echo "Shortcuts:"
        echo "  generated      - All generated styles"
        echo "  all            - Everything (default)"
        ;;
      current)
        echo ""
        echo "Current Background Mode"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo ""
        local current_mode
        current_mode=$(get_background_mode)
        if [[ "$current_mode" == "all" ]]; then
          echo "Mode: all (everything enabled)"
        else
          echo "Enabled modes:"
          echo "$current_mode" | while IFS= read -r mode; do
            echo "  - $mode"
          done
        fi
        ;;
      all)
        set_background_mode "all"
        echo "Set mode: all (everything enabled)"
        ;;
      add)
        if [[ -z "${4:-}" ]]; then
          echo "Error: mode name required" >&2
          echo "Usage: theme background mode add <mode>" >&2
          exit 1
        fi
        add_background_mode "$4"
        ;;
      remove)
        if [[ -z "${4:-}" ]]; then
          echo "Error: mode name required" >&2
          echo "Usage: theme background mode remove <mode>" >&2
          exit 1
        fi
        remove_background_mode "$4"
        ;;
      set)
        if [[ -z "${4:-}" ]]; then
          echo "Error: at least one mode required" >&2
          echo "Usage: theme background mode set <mode> [mode...]" >&2
          exit 1
        fi
        set_background_mode "${@:4}"
        echo "Set modes:"
        for mode in "${@:4}"; do
          echo "  - $mode"
        done
        ;;
      *)
        echo "Unknown mode command: ${3:-}" >&2
        echo "Usage: theme background mode [current|list|set|add|remove|all]" >&2
        exit 1
        ;;
      esac
      ;;
    like)
      local message="${*:3}"
      local background_id current_theme
      background_id=$(get_current_background)
      current_theme=$(get_current_theme)

      if [[ -z "$background_id" ]]; then
        echo "Error: No background currently set" >&2
        exit 1
      fi

      log_background_action "like" "$background_id" "$current_theme" "$message"
      sync_after_action

      local bg_type="${background_id%%:*}"
      local bg_value="${background_id#*:}"
      echo "Liked background for theme: $current_theme"
      if [[ "$bg_type" == "recolor" ]]; then
        echo "  Background: recolor ($(basename "$bg_value"))"
      else
        echo "  Background: $bg_value"
      fi
      [[ -n "$message" ]] && echo "  Note: $message"
      ;;
    dislike)
      local message="${*:3}"
      local background_id current_theme
      background_id=$(get_current_background)
      current_theme=$(get_current_theme)

      if [[ -z "$background_id" ]]; then
        echo "Error: No background currently set" >&2
        exit 1
      fi

      log_background_action "dislike" "$background_id" "$current_theme" "$message"
      sync_after_action

      local bg_type="${background_id%%:*}"
      local bg_value="${background_id#*:}"
      echo "Disliked background for theme: $current_theme"
      if [[ "$bg_type" == "recolor" ]]; then
        echo "  Background: recolor ($(basename "$bg_value"))"
      else
        echo "  Background: $bg_value"
      fi
      [[ -n "$message" ]] && echo "  Note: $message"
      ;;
    reject)
      local message="${*:3}"
      local background_id current_theme
      background_id=$(get_current_background)
      current_theme=$(get_current_theme)

      if [[ -z "$background_id" ]]; then
        echo "Error: No background currently set" >&2
        exit 1
      fi

      if [[ -z "$message" ]]; then
        echo "Error: Rejection reason required" >&2
        echo "Usage: theme background reject <reason>" >&2
        exit 1
      fi

      log_background_action "reject" "$background_id" "$current_theme" "$message"
      sync_after_action

      local bg_type="${background_id%%:*}"
      local bg_value="${background_id#*:}"
      echo "Rejected background for theme: $current_theme"
      if [[ "$bg_type" == "recolor" ]]; then
        echo "  Background: recolor ($(basename "$bg_value"))"
      else
        echo "  Background: $bg_value"
      fi
      echo "  Reason: $message"
      echo ""
      echo "This background will be skipped for this theme."
      ;;
    history)
      sync_before_read
      local history
      history=$(get_background_history)

      if [[ -z "$history" ]] || [[ "$history" == "[]" ]]; then
        echo "No background history yet."
        return
      fi

      echo ""
      echo "Background History"
      echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      echo ""

      echo "$history" | jq -r '.[] | "\(.ts) | \(.machine) | \(.theme) | \(.action) | \(.background)" + (if .message then " | \(.message)" else "" end)' | tail -20
      ;;
    rank)
      sync_before_read
      local current_theme global_flag
      current_theme=$(get_current_theme)
      global_flag="${3:-}"

      local rankings
      if [[ "$global_flag" == "--global" ]]; then
        echo ""
        echo "Global Background Rankings"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        rankings=$(get_background_rankings)
      else
        echo ""
        echo "Background Rankings for: $current_theme"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        rankings=$(get_background_rankings "$current_theme")
      fi

      if [[ -z "$rankings" ]]; then
        echo ""
        echo "No rankings yet. Apply and rate some backgrounds!"
        return
      fi

      echo ""
      local rank=0
      while IFS= read -r line; do
        rank=$((rank + 1))
        local background score likes dislikes applies
        background=$(echo "$line" | jq -r '.background')
        score=$(echo "$line" | jq -r '.score')
        likes=$(echo "$line" | jq -r '.likes')
        dislikes=$(echo "$line" | jq -r '.dislikes')
        applies=$(echo "$line" | jq -r '.applies')

        local bg_type="${background%%:*}"
        local bg_value="${background#*:}"
        local display_name
        if [[ "$bg_type" == "recolor" ]]; then
          display_name="recolor: $(basename "$bg_value")"
        else
          display_name="$background"
        fi

        printf "%2d. %s\n" "$rank" "$display_name"
        printf "    Score: %+d (%d likes, %d dislikes) | Applied: %d times\n" "$score" "$likes" "$dislikes" "$applies"
      done <<< "$rankings"
      echo ""
      ;;
    pre-generate)
      generate_all_backgrounds
      ;;
    cache-clear)
      clear_background_cache
      ;;
    source)
      case "${3:-}" in
      "" | --help | -h)
        background_source_usage
        ;;
      add)
        if [[ -z "${4:-}" ]]; then
          echo "Usage: theme background source add <path>" >&2
          exit 1
        fi
        add_background_source "$4"
        ;;
      list)
        local entries
        entries=$(list_background_source_entries)
        if [[ -z "$entries" ]]; then
          echo "No background sources configured."
          echo ""
          echo "Add sources with: theme background source add <path>"
          echo "You can add individual files or entire directories."
          echo ""
          echo "Sources are stored as path references in:"
          echo "  $BACKGROUND_SOURCES_FILE"
        else
          echo "Background Sources"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          while IFS= read -r entry; do
            local type="${entry%%:*}"
            local path="${entry#*:}"
            if [[ "$type" == "dir" ]]; then
              local count
              count=$(find "$path" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) 2>/dev/null | wc -l | xargs)
              echo "  [dir]  $path ($count images)"
            else
              echo "  [file] $path"
            fi
          done <<< "$entries"
          echo ""
          echo "Total images: $(get_all_background_images | wc -l | xargs)"
          echo ""
          echo "When 'recolor' style is selected, gowall converts these to match your theme."
        fi
        ;;
      remove)
        if [[ -z "${4:-}" ]]; then
          echo "Usage: theme background source remove <path>" >&2
          exit 1
        fi
        remove_background_source "$4"
        ;;
      verify)
        echo "Verifying background sources..."
        echo ""
        verify_background_sources
        ;;
      clean)
        echo "Cleaning broken background sources..."
        echo ""
        clean_background_sources
        ;;
      *)
        echo "Unknown background source command: ${3:-}"
        echo "Usage: theme background source [add|list|remove|verify|clean]"
        exit 1
        ;;
      esac
      ;;
    *)
      echo "Unknown background command: ${2:-}"
      echo "Usage: theme background [rotate|list|mode|like|dislike|reject|history|rank|pre-generate|cache-clear|source]"
      exit 1
      ;;
    esac
    ;;
  sync)
    case "${2:-}" in
    "" | --help | -h)
      sync_usage
      ;;
    init)
      sync_init
      ;;
    status)
      sync_status
      ;;
    push)
      if sync_push; then
        echo "‚úì Pushed to remote"
      else
        echo "‚úó Push failed" >&2
        exit 1
      fi
      ;;
    pull)
      if sync_pull; then
        echo "‚úì Pulled from remote"
      else
        echo "‚úó Pull failed" >&2
        exit 1
      fi
      ;;
    off)
      sync_off
      ;;
    on)
      sync_on
      ;;
    *)
      echo "Usage: theme sync <init|status|push|pull|on|off>"
      exit 1
      ;;
    esac
    ;;
  --version | -v)
    echo "theme $(get_version)"
    exit 0
    ;;
  help | --help | -h)
    usage
    ;;
  *)
    usage
    exit 1
    ;;
  esac
}

main "$@"
