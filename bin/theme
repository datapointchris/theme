#!/usr/bin/env bash
# Theme management - unified cross-platform theming
# Applies themes to terminal, tmux, fzf, shell, and more

set -euo pipefail

# Source the library (handle symlinks)
SCRIPT_PATH="${BASH_SOURCE[0]:-$0}"
if [[ -L "$SCRIPT_PATH" ]]; then
  SCRIPT_PATH="$(python3 -c "import os; print(os.path.realpath('$SCRIPT_PATH'))")"
fi
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
THEME_APP_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Source formatting library for colorized help
if [[ -f "$HOME/.local/shell/formatting.sh" ]]; then
  source "$HOME/.local/shell/formatting.sh"
elif [[ -f "$HOME/dotfiles/platforms/common/.local/shell/formatting.sh" ]]; then
  source "$HOME/dotfiles/platforms/common/.local/shell/formatting.sh"
fi

source "$THEME_APP_DIR/lib/lib.sh"
source "$THEME_APP_DIR/lib/storage.sh"
source "$THEME_APP_DIR/lib/sync.sh"

# Rename original functions and create filtered versions
eval "$(declare -f list_themes | sed '1s/list_themes/list_themes_unfiltered/')"
eval "$(declare -f list_themes_with_status | sed '1s/list_themes_with_status/list_themes_with_status_unfiltered/')"
eval "$(declare -f count_themes | sed '1s/count_themes/count_themes_unfiltered/')"

# Override list_themes to filter out rejected themes
list_themes() {
  list_themes_unfiltered | while IFS= read -r theme; do
    if ! is_theme_rejected "$theme"; then
      echo "$theme"
    fi
  done
}

# Override list_themes_with_status to filter out rejected themes and show display names
list_themes_with_status() {
  local current
  current=$(get_current_theme 2>/dev/null || echo "")

  list_themes | while IFS= read -r theme; do
    local display_info
    display_info=$(get_theme_display_info "$theme")
    if [[ "$theme" == "$current" ]]; then
      echo "‚óè $display_info (current)"
    else
      echo "  $display_info"
    fi
  done
}

# Override count_themes to use filtered list
count_themes() {
  list_themes | wc -l | xargs
}

#==============================================================================
# HELP
#==============================================================================

usage() {
  if command -v print_header &>/dev/null; then
    print_section "Theme Management" "yellow"

    print_section "Commands" "blue"
    cat <<'EOF'
  change               Interactive theme picker with color preview
  current              Show currently active theme
  list                 List available themes
  apply <theme>        Apply theme across all platform apps
  preview [theme]      Preview generated theme in tmux (fzf if no theme)
  random               Apply random theme
  like [message]       Like current theme with optional reason
  dislike [message]    Dislike current theme with optional reason
  note <message>       Add note to current theme (message required)
  rank                 Show themes ranked by likes/usage
  log                  View complete history
  info <theme>         Show theme details and app mappings
  reject <message>     Mark current theme as rejected (avoids rediscovery)
  rejected             List all rejected themes
  unreject             Restore a rejected theme (fzf picker with history)
  verify               Check theme system is working
  upgrade              Update theme to latest version (git pull)
  opacity              Show current background opacity
  opacity-up           Increase opacity by 5%
  opacity-down         Decrease opacity by 5%
  generate-previews    Pre-generate all preview images
  generate-wallpapers  Pre-generate all wallpapers (instant switching)
  wallpaper                    Show current wallpaper
  wallpaper rotate             Rotate to new wallpaper (keep theme)
  wallpaper like [note]        Like current wallpaper (for this theme)
  wallpaper dislike [note]     Dislike current wallpaper (for this theme)
  wallpaper reject <reason>    Reject wallpaper for this theme
  wallpaper history            Show wallpaper history
  wallpaper rank               Show wallpaper rankings for current theme
  wallpaper rank --global      Show global wallpaper rankings
  wallpaper source add <path>  Add image/directory for recoloring
  wallpaper source list        List configured sources
  wallpaper source remove <id> Remove a source
  wallpaper source verify      Check for broken source paths
  wallpaper source clean       Remove broken source entries
  clear-cache          Clear preview cache
  clear-wallpaper-cache  Clear wallpaper cache
  sync init            Initialize sync (creates gist)
  sync status          Show sync status
  sync push            Manual push to remote
  sync pull            Manual pull from remote
  sync on              Enable sync
  sync off             Disable sync
EOF

    print_section "Examples" "yellow"
    if command -v print_cyan &>/dev/null; then
      echo "  $(print_cyan "theme change")                       # Interactive picker with preview"
      echo "  $(print_cyan "theme list")                         # See available themes"
      echo "  $(print_cyan "theme apply \"Rose Pine\"")            # Apply a theme"
      echo "  $(print_cyan "theme like \"Great for night coding\"") # Like with reason"
      echo "  $(print_cyan "theme random")                       # Try something new"
      echo "  $(print_cyan "theme rank")                         # See rankings"
    else
      cat <<'EOF'
  theme change                       # Interactive picker with preview
  theme list                         # See available themes
  theme apply "Rose Pine"            # Apply a theme
  theme like "Great for night coding" # Like with reason
  theme random                       # Try something new
  theme rank                         # See rankings
EOF
    fi

    print_section "Data Storage" "green"
    cat <<'EOF'
  ~/.local/state/theme/
  ‚îú‚îÄ‚îÄ history.jsonl      # Usage history (synced via gist)
  ‚îú‚îÄ‚îÄ current            # Current theme ID
  ‚îî‚îÄ‚îÄ sync-state.json    # Sync configuration

  Sync with: theme sync init
EOF

  else
    cat <<'EOF'
Theme Management
================

Commands
--------
  change               Interactive theme picker with color preview
  current              Show currently active theme
  list                 List available themes
  apply <theme>        Apply theme across all platform apps
  preview [theme]      Preview generated theme in tmux (fzf if no theme)
  random               Apply random theme
  like [message]       Like current theme with optional reason
  dislike [message]    Dislike current theme with optional reason
  note <message>       Add note to current theme (message required)
  rank                 Show themes ranked by likes/usage
  log                  View complete history
  info <theme>         Show theme details and app mappings
  reject <message>     Mark current theme as rejected (avoids rediscovery)
  rejected             List all rejected themes
  unreject             Restore a rejected theme (fzf picker with history)
  verify               Check theme system is working
  upgrade              Update theme to latest version (git pull)
  opacity              Show current background opacity
  opacity-up           Increase opacity by 5%
  opacity-down         Decrease opacity by 5%
  sync                 Manage GitHub Gist synchronization
  generate-previews    Pre-generate all preview images
  generate-wallpapers  Pre-generate all wallpapers (instant switching)
  wallpaper            Manage wallpapers
  clear-cache          Clear preview cache
  clear-wallpaper-cache  Clear wallpaper cache

Wallpaper Commands
------------------
  wallpaper                       Show current wallpaper info
  wallpaper rotate                Rotate to new wallpaper (keep theme)
  wallpaper like [note]           Like current wallpaper (for this theme)
  wallpaper dislike [note]        Dislike current wallpaper (for this theme)
  wallpaper reject <reason>       Reject wallpaper for this theme
  wallpaper history               Show wallpaper history
  wallpaper rank                  Show rankings for current theme
  wallpaper rank --global         Show global wallpaper rankings
  wallpaper source add <path>     Add image or directory for recoloring
  wallpaper source list           List configured sources
  wallpaper source remove <id>    Remove a source
  wallpaper source verify         Check for broken source paths
  wallpaper source clean          Remove broken source entries

  Preferences are per-theme: a wallpaper liked for Gruvbox may be
  rejected for Nord. Sources are stored as path references (not copied).
  gowall converts your images to match the current theme's color palette.

Sync Commands
-------------
  sync init            Initialize sync (creates gist)
  sync status          Show sync status
  sync push            Manual push to remote
  sync pull            Manual pull from remote
  sync on              Enable sync
  sync off             Disable sync

Examples
--------
  theme change
  theme list
  theme apply "Rose Pine"
  theme like "Great for night coding"
  theme random
  theme rank

Data Storage
------------
  ~/.local/state/theme/
  ‚îú‚îÄ‚îÄ history.jsonl      # Usage history (synced via gist)
  ‚îú‚îÄ‚îÄ current            # Current theme ID
  ‚îî‚îÄ‚îÄ sync-state.json    # Sync configuration

  Sync with: theme sync init
EOF
  fi
}

#==============================================================================
# THEME OPERATIONS
#==============================================================================

show_current() {
  sync_before_read
  local current
  current=$(get_current_theme)

  if [[ -z "$current" ]]; then
    echo "No theme currently applied"
    return
  fi

  local display_info
  display_info=$(get_theme_display_info "$current")

  echo ""
  echo "Current Theme: $display_info"
  echo "            ID: $current"
  echo ""

  local stats
  stats=$(get_theme_stats "$current" 2>/dev/null || echo "{}")

  if [[ -n "$stats" ]] && [[ "$stats" != "{}" ]] && [[ "$stats" != "null" ]]; then
    local score=$(echo "$stats" | jq -r '.score // 0')
    local likes=$(echo "$stats" | jq -r '.likes // 0')
    local dislikes=$(echo "$stats" | jq -r '.dislikes // 0')
    local notes=$(echo "$stats" | jq -r '.notes // 0')
    local applies=$(echo "$stats" | jq -r '.applies // 0')

    printf "Score: %+d (%d likes, %d dislikes)\n" "$score" "$likes" "$dislikes"
    printf "Notes: %d | Times applied: %d\n" "$notes" "$applies"
  fi

  local base16
  base16=$(get_theme_mapping "$current" "base16" 2>/dev/null || echo "")
  local ghostty
  ghostty=$(get_theme_mapping "$current" "ghostty" 2>/dev/null || echo "")

  echo ""
  echo "App mappings:"
  [[ -n "$base16" ]] && echo "  Base16: $base16"
  [[ -n "$ghostty" ]] && echo "  Ghostty: $ghostty"
}

show_list() {
  local platform
  platform=$(detect_platform)

  if command -v print_blue &>/dev/null; then
    print_blue "Available Themes ($(count_themes) total)"
  else
    echo "Available Themes ($(count_themes) total)"
  fi
  echo ""

  list_themes_with_status

  echo ""
  echo "Apply with: theme apply <name>"
}

apply_theme() {
  local theme_input="$1"

  if [[ -z "$theme_input" ]]; then
    echo "Error: Theme name required"
    echo "Usage: theme apply <theme-name>"
    echo ""
    echo "Available themes:"
    list_themes | head -10
    exit 1
  fi

  local canonical
  canonical=$(theme_name_to_canonical "$theme_input")

  # Check if theme is in library
  local lib_path
  lib_path=$(get_library_path "$canonical")

  local display_info
  display_info=$(get_theme_display_info "$canonical")

  echo "Applying theme: $display_info"
  if [[ -z "$lib_path" ]]; then
    echo "  (not in library - limited app support)"
  fi
  echo ""

  # Apply to all apps
  local result
  result=$(apply_theme_to_apps "$canonical")

  local applied
  applied=$(echo "$result" | grep "^APPLIED:" | cut -d: -f2)
  local wallpaper_id
  wallpaper_id=$(echo "$result" | grep "^WALLPAPER:" | cut -d: -f2-)

  # Reload applicable apps
  reload_apps "$applied"

  # Log the theme action
  log_action "apply" "$canonical"

  # Log the wallpaper action if one was applied
  if [[ -n "$wallpaper_id" ]] && [[ "$wallpaper_id" != "none" ]]; then
    log_wallpaper_action "apply" "$wallpaper_id" "$canonical"
  fi

  sync_after_action

  echo ""
  echo "Theme applied."
}

apply_random() {
  local themes
  mapfile -t themes < <(list_themes)

  if [[ ${#themes[@]} -eq 0 ]]; then
    echo "Error: No themes found"
    exit 1
  fi

  # Get apply counts for all themes
  declare -A apply_counts
  while IFS=$'\t' read -r theme count; do
    apply_counts["$theme"]=$count
  done < <(get_all_apply_counts)

  # Find minimum apply count among available themes
  local min_count=999999
  for theme in "${themes[@]}"; do
    local count="${apply_counts[$theme]:-0}"
    if [[ $count -lt $min_count ]]; then
      min_count=$count
    fi
  done

  # Get all themes with minimum apply count
  local least_used=()
  for theme in "${themes[@]}"; do
    local count="${apply_counts[$theme]:-0}"
    if [[ $count -eq $min_count ]]; then
      least_used+=("$theme")
    fi
  done

  # Pick randomly from least-used themes
  local random_theme="${least_used[$RANDOM % ${#least_used[@]}]}"

  local display_info
  display_info=$(get_theme_display_info "$random_theme")
  echo "üé≤ Randomly selected: $display_info"
  echo "   (${#least_used[@]} themes with $min_count applies)"
  echo ""
  apply_theme "$random_theme"
}

change_theme() {
  if ! command -v fzf &>/dev/null; then
    echo "Error: fzf not found. Install with: brew install fzf"
    exit 1
  fi

  if ! command -v magick &>/dev/null; then
    echo "Error: ImageMagick not found. Install with: brew install imagemagick"
    exit 1
  fi

  if ! command -v chafa &>/dev/null && ! command -v viu &>/dev/null; then
    echo "Note: Install 'chafa' or 'viu' for image preview support"
    echo "  brew install chafa"
    echo ""
    echo "Continuing with text-based preview..."
    sleep 2
  fi

  mkdir -p "$PREVIEW_CACHE_DIR"

  local preview_script="/tmp/theme-fzf-preview-$$.sh"
  local preview_log="/tmp/theme-preview-debug.log"
  cat >"$preview_script" <<PREVIEW_EOF
#!/bin/bash
exec 2>>"$preview_log"
echo "=== Preview for: \$1 ===" >>"$preview_log"

if ! source "$THEME_APP_DIR/lib/lib.sh" 2>>"$preview_log"; then
  echo "ERROR: Failed to source lib.sh"
  exit 1
fi

theme="\$1"

if [[ -n "\${TMUX:-}" ]]; then
  display_theme_details "\$theme" "full"
  echo ""
  echo "Graphics preview not available in tmux."
  echo "Open a regular terminal window to see theme preview."
elif preview_file=\$(get_or_generate_preview "\$theme" 2>>"$preview_log"); then
  echo "Preview file: \$preview_file" >>"$preview_log"
  display_theme_details "\$theme" "compact"
  echo ""
  if command -v chafa &>/dev/null; then
    chafa -f kitty --speed 10 --dither none "\$preview_file" 2>>"$preview_log" || echo "Preview: \$theme"
  elif command -v viu &>/dev/null; then
    viu -w 80 "\$preview_file" 2>>"$preview_log" || echo "Preview: \$theme"
  else
    echo "(Install chafa or viu for image preview)"
    display_theme_details "\$theme" "full"
  fi
else
  echo "Failed to generate preview"
  display_theme_details "\$theme" "full"
fi
PREVIEW_EOF

  chmod +x "$preview_script"

  # Build list with display names and IDs (tab-separated)
  local theme_list=""
  while IFS= read -r theme_id; do
    local display_info
    display_info=$(get_theme_display_info "$theme_id")
    theme_list+="${display_info}"$'\t'"${theme_id}"$'\n'
  done < <(list_themes)

  local selected
  selected=$(echo -n "$theme_list" | fzf \
    --prompt="Select theme > " \
    --height=100% \
    --delimiter=$'\t' \
    --with-nth=1 \
    --preview="$preview_script {2}" \
    --preview-window=right:60%)

  rm -f "$preview_script"

  if [[ -n "$selected" ]]; then
    # Extract the theme ID (second field)
    local theme_id
    theme_id=$(echo "$selected" | cut -f2)
    apply_theme "$theme_id"
  fi
}

mark_liked() {
  local message="$*"
  local theme
  theme=$(get_current_theme)

  if [[ -z "$theme" ]]; then
    echo "Error: No theme currently applied"
    exit 1
  fi

  local display_info
  display_info=$(get_theme_display_info "$theme")

  log_action "like" "$theme" "$message"
  sync_after_action
  echo "Liked: $display_info"
  [[ -n "$message" ]] && echo "  Reason: $message"
}

mark_disliked() {
  local message="$*"
  local theme
  theme=$(get_current_theme)

  if [[ -z "$theme" ]]; then
    echo "Error: No theme currently applied"
    exit 1
  fi

  local display_info
  display_info=$(get_theme_display_info "$theme")

  log_action "dislike" "$theme" "$message"
  sync_after_action
  echo "Disliked: $display_info"
  [[ -n "$message" ]] && echo "  Reason: $message"
}

add_note() {
  local message="$*"
  local theme
  theme=$(get_current_theme)

  if [[ -z "$theme" ]]; then
    echo "Error: No theme currently applied"
    exit 1
  fi

  if [[ -z "$message" ]]; then
    echo "Error: Note message required"
    echo "Usage: theme note <message>"
    exit 1
  fi

  local display_info
  display_info=$(get_theme_display_info "$theme")

  log_action "note" "$theme" "$message"
  sync_after_action
  echo "Added note to: $display_info"
  echo "  Note: $message"
}

mark_rejected() {
  local reason="$*"
  local theme
  theme=$(get_current_theme)

  if [[ -z "$theme" ]]; then
    echo "Error: No theme currently applied"
    exit 1
  fi

  if [[ -z "$reason" ]]; then
    echo "Error: Rejection reason required"
    echo "Usage: theme reject <message>"
    exit 1
  fi

  local display_info
  display_info=$(get_theme_display_info "$theme")

  reject_theme "$theme" "$reason"
  sync_after_action
  echo "Marked as rejected: $display_info"
  echo "  Reason: $reason"
  echo ""
  echo "This theme will be tracked to avoid rediscovery."
}

show_rejected() {
  local rejected
  rejected=$(list_rejected_themes)

  if [[ -z "$rejected" ]] || [[ "$rejected" == "[]" ]]; then
    echo "No rejected themes yet."
    echo ""
    echo "When you try a theme and don't like it, mark it as rejected:"
    echo "  theme reject \"reason\""
    return
  fi

  echo ""
  echo "Rejected Themes"
  echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
  echo ""

  local count=0
  while IFS= read -r line; do
    count=$((count + 1))
    local theme=$(echo "$line" | jq -r '.theme')
    local rejected_date=$(echo "$line" | jq -r '.rejected_date')
    local reason=$(echo "$line" | jq -r '.reason')
    local platforms=$(echo "$line" | jq -r '.platforms')

    local display_info
    display_info=$(get_theme_display_info "$theme")

    local date_formatted
    if date --version &>/dev/null 2>&1; then
      date_formatted=$(date -d "$rejected_date" +"%Y-%m-%d" 2>/dev/null || echo "$rejected_date")
    else
      date_formatted=$(date -j -f "%Y-%m-%dT%H:%M:%S" "${rejected_date:0:19}" +"%Y-%m-%d" 2>/dev/null || echo "$rejected_date")
    fi

    echo "$count. $display_info"
    echo "   ID: $theme"
    echo "   Rejected: $date_formatted"
    echo "   Reason: $reason"
    [[ -n "$platforms" ]] && echo "   Platforms: $platforms"
    echo ""
  done < <(echo "$rejected")

  echo "Total rejected: $count"
  echo ""
}

unreject_theme_interactive() {
  if ! command -v fzf &>/dev/null; then
    echo "Error: fzf not found. Install with: brew install fzf"
    exit 1
  fi

  local rejected
  rejected=$(list_rejected_themes)

  if [[ -z "$rejected" ]] || [[ "$rejected" == "[]" ]]; then
    echo "No rejected themes to unreject."
    return
  fi

  local theme_ids
  theme_ids=$(echo "$rejected" | jq -r '.theme')

  if [[ -z "$theme_ids" ]]; then
    echo "No rejected themes to unreject."
    return
  fi

  # Build list with display names and IDs (tab-separated)
  local theme_list=""
  while IFS= read -r theme_id; do
    local display_info
    display_info=$(get_theme_display_info "$theme_id")
    theme_list+="${display_info}"$'\t'"${theme_id}"$'\n'
  done <<<"$theme_ids"

  local preview_script="/tmp/theme-unreject-preview-$$.sh"
  cat >"$preview_script" <<'PREVIEW_EOF'
#!/bin/bash
theme="$1"
THEME_APP_DIR="$2"

source "$THEME_APP_DIR/lib/storage.sh"

echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "Theme: $theme"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""

echo "REJECTION INFO:"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
rejection_info=$(get_rejected_theme_info "$theme")
if [[ -n "$rejection_info" ]] && [[ "$rejection_info" != "{}" ]]; then
  rejected_date=$(echo "$rejection_info" | jq -r '.ts // "unknown"')
  reason=$(echo "$rejection_info" | jq -r '.message // "No reason"')
  machine=$(echo "$rejection_info" | jq -r '.machine // .platform // "unknown"')
  echo "  Date: $rejected_date"
  echo "  Reason: $reason"
  echo "  Machine: $machine"
else
  echo "  No rejection info found"
fi
echo ""

echo "FULL HISTORY:"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
history=$(get_history | jq -c --arg theme "$theme" '.[] | select(.theme == $theme)')
if [[ -n "$history" ]]; then
  echo "$history" | while IFS= read -r line; do
    ts=$(echo "$line" | jq -r '.ts')
    action=$(echo "$line" | jq -r '.action')
    machine=$(echo "$line" | jq -r '.machine // .platform')
    message=$(echo "$line" | jq -r '.message // empty')

    date_part="${ts:0:10}"

    if [[ -n "$message" ]]; then
      printf "  %s | %-8s | %s | %s\n" "$date_part" "$action" "$machine" "$message"
    else
      printf "  %s | %-8s | %s\n" "$date_part" "$action" "$machine"
    fi
  done
else
  echo "  No history found"
fi
echo ""

echo "STATS SUMMARY:"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
stats=$(get_theme_stats "$theme" 2>/dev/null)
if [[ -n "$stats" ]] && [[ "$stats" != "null" ]]; then
  likes=$(echo "$stats" | jq -r '.likes // 0')
  dislikes=$(echo "$stats" | jq -r '.dislikes // 0')
  applies=$(echo "$stats" | jq -r '.applies // 0')
  score=$(echo "$stats" | jq -r '.score // 0')
  printf "  Score: %+d (%d likes, %d dislikes)\n" "$score" "$likes" "$dislikes"
  echo "  Times applied: $applies"
else
  echo "  No stats available"
fi
PREVIEW_EOF

  chmod +x "$preview_script"

  local selected
  selected=$(echo -n "$theme_list" | fzf \
    --prompt="Select theme to unreject > " \
    --height=80% \
    --delimiter=$'\t' \
    --with-nth=1 \
    --preview="$preview_script {2} '$THEME_APP_DIR'" \
    --preview-window=right:60%)

  rm -f "$preview_script"

  if [[ -n "$selected" ]]; then
    # Extract the theme ID (second field)
    local theme_id display_info
    theme_id=$(echo "$selected" | cut -f2)
    display_info=$(echo "$selected" | cut -f1)

    unreject_theme "$theme_id"
    sync_after_action
    echo "Unrejected: $display_info"
    echo ""
    echo "This theme is now available in the theme list again."
  fi
}

show_rankings() {
  sync_before_read
  local rankings
  rankings=$(get_rankings)

  if [[ -z "$rankings" ]] || [[ "$rankings" == "null" ]]; then
    echo "No theme data yet. Start using themes!"
    return
  fi

  echo ""
  echo "Theme Rankings (by score and usage)"
  echo ""

  local rank=0
  while IFS= read -r line; do
    rank=$((rank + 1))
    local theme=$(echo "$line" | jq -r '.theme')
    local score=$(echo "$line" | jq -r '.score')
    local likes=$(echo "$line" | jq -r '.likes')
    local dislikes=$(echo "$line" | jq -r '.dislikes')
    local last_used=$(echo "$line" | jq -r '.last_used')
    local platforms=$(echo "$line" | jq -r '.platforms')
    local usage_seconds=$(echo "$line" | jq -r '.usage_seconds // 0')

    local display_info
    display_info=$(get_theme_display_info "$theme")

    if [[ "$last_used" == "never" ]]; then
      last_used="never used"
    else
      last_used=$(date -d "$last_used" "+%b %d, %Y" 2>/dev/null || echo "$last_used")
    fi

    local usage_time="not used"
    if [[ "$usage_seconds" -gt 0 ]]; then
      usage_time=$(format_duration "$usage_seconds")
    fi

    printf "%2d. %s\n" "$rank" "$display_info"
    printf "    Score: %+d (%d likes, %d dislikes)\n" "$score" "$likes" "$dislikes"
    printf "    Usage time: %s\n" "$usage_time"
    printf "    Last used: %s\n" "$last_used"
    [[ -n "$platforms" ]] && printf "    Platforms: %s\n" "$platforms"
    echo ""
  done <<<"$rankings"
}

show_log() {
  sync_before_read
  local history
  history=$(get_history_raw)

  if [[ -z "$history" ]]; then
    echo "No history yet. Start using themes!"
    return
  fi

  echo ""
  echo "Theme History Log"
  echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
  echo ""

  echo "Data file: $THEME_HISTORY_FILE"
  if [[ -f "$THEME_HISTORY_FILE" ]]; then
    local count
    count=$(wc -l <"$THEME_HISTORY_FILE" | xargs)
    echo "  $count entries"
  fi
  echo ""

  if command -v bat &>/dev/null; then
    echo "$history" | jq -r '
      "\(.ts) | \(.machine // .platform) | \(.action) | \(.theme)" +
      (if .message then " | \(.message)" else "" end)
    ' | bat --plain --language=log --theme=base16
  else
    echo "$history" | jq -r '
      "\(.ts) | \(.machine // .platform) | \(.action) | \(.theme)" +
      (if .message then " | \(.message)" else "" end)
    '
  fi
}

show_info() {
  local theme_input="$1"

  if [[ -z "$theme_input" ]]; then
    echo "Error: Theme name required"
    echo "Usage: theme info <theme-name>"
    exit 1
  fi

  local canonical
  canonical=$(theme_name_to_canonical "$theme_input")

  local theme_data
  theme_data=$(get_theme_by_name "$canonical")

  if [[ -z "$theme_data" ]] || [[ "$theme_data" == "null" ]]; then
    echo "Theme not found: $theme_input"
    echo ""
    echo "Available themes:"
    list_themes | head -10
    exit 1
  fi

  local display_info
  display_info=$(get_theme_display_info "$canonical")

  echo ""
  echo "Theme: $display_info"
  echo "    ID: $canonical"
  echo ""

  echo "App Mappings:"
  local ghostty=$(echo "$theme_data" | yq -r '.ghostty // "not available"')
  local kitty=$(echo "$theme_data" | yq -r '.kitty // "not available"')
  local neovim=$(echo "$theme_data" | yq -r '.neovim // "not available"')
  local base16=$(echo "$theme_data" | yq -r '.base16 // "not available"')
  local windows=$(echo "$theme_data" | yq -r '.windows_terminal // "not available"')

  echo "  Ghostty: $ghostty"
  echo "  Kitty: $kitty"
  echo "  Neovim: $neovim"
  echo "  Base16: $base16"
  echo "  Windows Terminal: $windows"

  local tags=$(echo "$theme_data" | yq -r '.tags | join(", ") // "none"')
  echo ""
  echo "Tags: $tags"

  local stats
  stats=$(get_theme_stats "$canonical" 2>/dev/null || echo "{}")

  if [[ -n "$stats" ]] && [[ "$stats" != "{}" ]] && [[ "$stats" != "null" ]]; then
    local score=$(echo "$stats" | jq -r '.score // 0')
    local likes=$(echo "$stats" | jq -r '.likes // 0')
    local dislikes=$(echo "$stats" | jq -r '.dislikes // 0')
    local applies=$(echo "$stats" | jq -r '.applies // 0')

    echo ""
    echo "Your Stats:"
    printf "  Score: %+d (%d likes, %d dislikes)\n" "$score" "$likes" "$dislikes"
    printf "  Times applied: %d\n" "$applies"
  fi
}

verify_system() {
  echo "Verifying theme system..."
  echo ""

  local errors=0

  # Check themes directory
  if [[ -d "$THEMES_DIR" ]]; then
    local count
    count=$(count_themes)
    echo "  Themes directory: $count themes available"
  else
    echo "  ERROR: Themes directory not found: $THEMES_DIR"
    errors=$((errors + 1))
  fi

  # Check yq
  if command -v yq &>/dev/null; then
    echo "  yq: installed"
  else
    echo "  ERROR: yq not installed"
    errors=$((errors + 1))
  fi

  # Check current theme
  local current
  current=$(get_current_theme 2>/dev/null || echo "")
  if [[ -n "$current" ]]; then
    local display_info
    display_info=$(get_theme_display_info "$current")
    echo "  Current theme: $display_info"
    echo "    ID: $current"
    local theme_path
    theme_path=$(get_theme_path "$current")
    if [[ -n "$theme_path" ]]; then
      local configs=""
      for f in "$theme_path"/*.{conf,theme,css}; do
        [[ -f "$f" ]] && configs+="$(basename "$f") "
      done
      echo "    Generated configs: $configs"
    fi
  else
    echo "  Current theme: none applied"
  fi

  # Platform
  local platform
  platform=$(detect_platform)
  echo "  Platform: $platform"

  echo ""
  if [[ $errors -eq 0 ]]; then
    echo "System ready!"
  else
    echo "Found $errors error(s). Run: task symlinks:link"
  fi
}

#==============================================================================
# PREVIEW
#==============================================================================

GENERATED_THEMES_DIR="$THEME_APP_DIR/themes"
DEMO_DIR="$THEME_APP_DIR/demo"
GHOSTTY_THEME="${HOME}/.config/ghostty/themes/current.conf"
BTOP_THEME="${HOME}/.config/btop/themes/current.theme"
TMUX_THEME="${HOME}/.config/tmux/themes/current.conf"

list_generated_themes() {
  for dir in "$GENERATED_THEMES_DIR"/*/; do
    [[ -d "$dir" ]] && basename "$dir"
  done
}

select_generated_theme() {
  if command -v fzf &>/dev/null; then
    list_generated_themes | fzf --prompt="Select theme to preview: "
  else
    local themes
    mapfile -t themes < <(list_generated_themes)
    select theme in "${themes[@]}"; do
      [[ -n "$theme" ]] && echo "$theme" && break
    done
  fi
}

apply_preview_themes() {
  local theme_name="$1"
  local theme_path="$GENERATED_THEMES_DIR/$theme_name"

  # Ghostty
  if [[ -f "$theme_path/ghostty.conf" ]]; then
    cp "$theme_path/ghostty.conf" "$GHOSTTY_THEME"
    echo "  Applied: ghostty"
  fi

  # btop
  if [[ -f "$theme_path/btop.theme" ]]; then
    mkdir -p "$(dirname "$BTOP_THEME")"
    cp "$theme_path/btop.theme" "$BTOP_THEME"
    echo "  Applied: btop"
  fi

  # tmux
  if [[ -f "$theme_path/tmux.conf" ]]; then
    mkdir -p "$(dirname "$TMUX_THEME")"
    cp "$theme_path/tmux.conf" "$TMUX_THEME"
    tmux source-file "$TMUX_THEME" 2>/dev/null || true
    echo "  Applied: tmux"
  fi
}

create_preview_window() {
  local theme_name="$1"
  local window_name="preview-$theme_name"
  local theme_path="$GENERATED_THEMES_DIR/$theme_name"

  # Get neovim colorscheme from theme.yml (defaults to theme_name if not specified)
  local nvim_colorscheme="$theme_name"
  if [[ -f "$theme_path/theme.yml" ]]; then
    local yml_colorscheme
    yml_colorscheme=$(yq -r '.meta.neovim_colorscheme // empty' "$theme_path/theme.yml" 2>/dev/null || true)
    if [[ -n "$yml_colorscheme" ]]; then
      nvim_colorscheme="$yml_colorscheme"
    fi
  fi

  # Create new window in current session
  tmux new-window -n "$window_name" -c "$DEMO_DIR"

  # Left: neovim with sample code
  tmux send-keys "nvim -c 'colorscheme $nvim_colorscheme' sample.py" Enter

  # Split right 40%
  tmux split-window -h -p 40 -c "$HOME/dotfiles"

  # Right top: btop
  tmux send-keys "btop" Enter

  # Split bottom right 50%
  tmux split-window -v -p 50 -c "$HOME/dotfiles"

  # Bottom right: git status + ls
  tmux send-keys "echo '=== $theme_name ===' && echo '' && git status --short && echo '' && ls --color=always" Enter

  # Focus neovim pane
  tmux select-pane -L
}

show_preview() {
  local theme_name="${1:-}"

  # Select theme if not provided
  if [[ -z "$theme_name" ]]; then
    theme_name=$(select_generated_theme)
    [[ -z "$theme_name" ]] && return 0
  fi

  # Verify theme exists
  if [[ ! -d "$GENERATED_THEMES_DIR/$theme_name" ]]; then
    echo "Error: Theme not found: $theme_name"
    echo "Available themes:"
    list_generated_themes | sed 's/^/  /'
    return 1
  fi

  echo "Preview: $theme_name"
  apply_preview_themes "$theme_name"
  echo ""
  echo "Reload Ghostty: Cmd+Shift+,"
  echo "Close preview window: prefix+& or :q in vim, q in btop, exit in shell"
  echo ""

  if [[ -n "${TMUX:-}" ]]; then
    create_preview_window "$theme_name"
  else
    echo "Error: Must be in tmux to create preview window"
    return 1
  fi
}

generate_all_previews() {
  echo "Pre-generating all theme previews..."
  echo "This will take a few minutes but makes browsing instant."
  echo ""

  if ! command -v magick &>/dev/null; then
    echo "Error: ImageMagick not found. Install with: brew install imagemagick"
    exit 1
  fi

  mkdir -p "$PREVIEW_CACHE_DIR"

  local themes
  themes=$(list_themes)
  local total
  total=$(echo "$themes" | wc -l | xargs)
  local current=0

  while IFS= read -r theme; do
    current=$((current + 1))
    printf "[%d/%d] Generating preview for: %s\n" "$current" "$total" "$theme"

    local cache_file
    cache_file=$(get_cached_preview_path "$theme")

    if [[ -f "$cache_file" ]] && validate_preview_image "$cache_file" &>/dev/null; then
      echo "  ‚úì Already exists"
      continue
    fi

    if generate_theme_preview "$theme" "$cache_file" 2>/dev/null; then
      echo "  ‚úì Generated"
    else
      echo "  ‚úó Failed"
    fi
  done <<<"$themes"

  echo ""
  echo "‚úì All previews generated!"
  echo "  Cache location: $PREVIEW_CACHE_DIR"
  echo "  Run 'theme change' for instant browsing"
}

#==============================================================================
# WALLPAPER CACHE
#==============================================================================

generate_all_wallpapers() {
  echo "Pre-generating all theme wallpapers..."
  echo "This will take a while but makes theme switching instant."
  echo ""

  if ! command -v magick &>/dev/null; then
    echo "Error: ImageMagick not found. Install with: brew install imagemagick"
    exit 1
  fi

  local styles=("plasma" "geometric" "hexagons" "circles" "swirl" "spotlight" "sphere" "spheres")
  local generator_script="$THEME_APP_DIR/lib/generators/wallpaper.sh"

  if [[ ! -f "$generator_script" ]]; then
    echo "Error: Wallpaper generator not found"
    exit 1
  fi

  local themes
  themes=$(list_themes)
  local total
  total=$(echo "$themes" | wc -l | xargs)
  local current=0

  while IFS= read -r theme; do
    current=$((current + 1))
    local lib_path
    lib_path=$(get_library_path "$theme")

    if [[ -z "$lib_path" ]] || [[ ! -f "$lib_path/theme.yml" ]]; then
      printf "[%d/%d] %s - skipped (no theme.yml)\n" "$current" "$total" "$theme"
      continue
    fi

    printf "[%d/%d] %s\n" "$current" "$total" "$theme"

    local cache_dir="$WALLPAPER_CACHE_DIR/$theme"
    mkdir -p "$cache_dir"

    for style in "${styles[@]}"; do
      local cache_file="$cache_dir/${style}.png"

      if [[ -f "$cache_file" ]]; then
        printf "  %-10s ‚úì exists\n" "$style"
        continue
      fi

      if bash "$generator_script" "$lib_path/theme.yml" "$cache_file" "$style" 1920 1080 2>/dev/null; then
        printf "  %-10s ‚úì generated\n" "$style"
      else
        printf "  %-10s ‚úó failed\n" "$style"
      fi
    done
  done <<<"$themes"

  echo ""
  echo "‚úì All wallpapers generated!"
  echo "  Cache location: $WALLPAPER_CACHE_DIR"
  local size
  size=$(du -sh "$WALLPAPER_CACHE_DIR" 2>/dev/null | cut -f1)
  echo "  Cache size: $size"
}

clear_wallpaper_cache() {
  if [[ -d "$WALLPAPER_CACHE_DIR" ]]; then
    local size
    size=$(du -sh "$WALLPAPER_CACHE_DIR" 2>/dev/null | cut -f1)
    rm -rf "$WALLPAPER_CACHE_DIR"
    echo "‚úì Cleared wallpaper cache ($size)"
  else
    echo "Wallpaper cache is empty"
  fi
}

#==============================================================================
# MAIN
#==============================================================================

main() {
  case "${1:-}" in
  change)
    change_theme
    ;;
  preview)
    show_preview "${2:-}"
    ;;
  current)
    show_current
    ;;
  list | ls)
    show_list
    ;;
  apply)
    apply_theme "${2:-}"
    ;;
  random | rand)
    apply_random
    ;;
  like)
    mark_liked "${@:2}"
    ;;
  dislike)
    mark_disliked "${@:2}"
    ;;
  note)
    add_note "${@:2}"
    ;;
  rank | ranks | ranking)
    show_rankings
    ;;
  log | history)
    show_log
    ;;
  info)
    show_info "${2:-}"
    ;;
  reject)
    mark_rejected "${@:2}"
    ;;
  rejected)
    show_rejected
    ;;
  unreject)
    unreject_theme_interactive
    ;;
  verify)
    verify_system
    ;;
  upgrade | update)
    local before_commit after_commit
    before_commit=$(git -C "$THEME_APP_DIR" rev-parse HEAD)

    if ! git -C "$THEME_APP_DIR" pull --quiet; then
      echo "‚úó theme upgrade failed" >&2
      exit 1
    fi

    after_commit=$(git -C "$THEME_APP_DIR" rev-parse HEAD)

    if [[ "$before_commit" == "$after_commit" ]]; then
      echo "‚úì theme is already up to date"
    else
      local before_desc after_desc
      before_desc=$(git -C "$THEME_APP_DIR" describe --tags --always "$before_commit" 2>/dev/null || echo "${before_commit:0:7}")
      after_desc=$(git -C "$THEME_APP_DIR" describe --tags --always "$after_commit" 2>/dev/null || echo "${after_commit:0:7}")
      echo "‚úì theme upgraded from $before_desc to $after_desc"
      echo ""
      echo "Changes:"
      git -C "$THEME_APP_DIR" log --format="  ‚Ä¢ %s" "${before_commit}..${after_commit}"
    fi
    ;;
  opacity)
    echo "Background opacity: $(get_current_opacity)"
    ;;
  opacity-up)
    if result=$(change_opacity 0.05); then
      echo "Opacity: $result"
      echo ""
      echo "Restart terminal to see changes."
    fi
    ;;
  opacity-down)
    if result=$(change_opacity -0.05); then
      echo "Opacity: $result"
      echo ""
      echo "Restart terminal to see changes."
    fi
    ;;
  generate-previews)
    generate_all_previews
    ;;
  generate-wallpapers)
    generate_all_wallpapers
    ;;
  clear-cache)
    clear_preview_cache
    ;;
  clear-wallpaper-cache)
    clear_wallpaper_cache
    ;;
  wallpaper)
    case "${2:-}" in
    "")
      # Show current wallpaper info
      local current_wp current_theme
      current_wp=$(get_current_wallpaper)
      current_theme=$(get_current_theme)

      if [[ -z "$current_wp" ]]; then
        echo "No wallpaper tracked yet."
        echo ""
        echo "Apply a theme to set wallpaper: theme apply <name>"
      else
        echo ""
        echo "Current Wallpaper"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        local wp_type="${current_wp%%:*}"
        local wp_value="${current_wp#*:}"
        echo "  Type: $wp_type"
        if [[ "$wp_type" == "recolor" ]]; then
          echo "  Source: $wp_value"
          echo "  File: $(basename "$wp_value")"
        else
          echo "  Style: $wp_value"
        fi
        echo "  Theme: $current_theme"
        echo ""
        echo "Rotate wallpaper: theme wallpaper rotate"
      fi
      ;;
    rotate)
      local platform
      platform=$(detect_platform)
      if [[ "$platform" != "macos" ]]; then
        echo "Error: Wallpaper rotation only supported on macOS" >&2
        exit 1
      fi

      echo "Rotating wallpaper..."

      # Get current theme for filtering
      local current_theme
      current_theme=$(get_current_theme)

      # Get rejected wallpapers and weights for this theme
      local rejected_list weights_json
      rejected_list=$(get_rejected_wallpaper_ids "$current_theme")
      weights_json=$(compute_wallpaper_weights "$current_theme")

      local new_style
      if new_style=$(rotate_wallpaper "$rejected_list" "$weights_json"); then
        echo "  ‚úì wallpaper ($new_style)"
        # Log the wallpaper action
        local wallpaper_id
        wallpaper_id=$(get_current_wallpaper)
        log_wallpaper_action "apply" "$wallpaper_id" "$current_theme"
        sync_after_action
      else
        echo "  ‚úó wallpaper rotation failed" >&2
        exit 1
      fi
      ;;
    like)
      local message="${*:3}"
      local wallpaper_id current_theme
      wallpaper_id=$(get_current_wallpaper)
      current_theme=$(get_current_theme)

      if [[ -z "$wallpaper_id" ]]; then
        echo "Error: No wallpaper currently set" >&2
        exit 1
      fi

      log_wallpaper_action "like" "$wallpaper_id" "$current_theme" "$message"
      sync_after_action

      local wp_type="${wallpaper_id%%:*}"
      local wp_value="${wallpaper_id#*:}"
      echo "Liked wallpaper for theme: $current_theme"
      if [[ "$wp_type" == "recolor" ]]; then
        echo "  Wallpaper: recolor ($(basename "$wp_value"))"
      else
        echo "  Wallpaper: $wp_value"
      fi
      [[ -n "$message" ]] && echo "  Note: $message"
      ;;
    dislike)
      local message="${*:3}"
      local wallpaper_id current_theme
      wallpaper_id=$(get_current_wallpaper)
      current_theme=$(get_current_theme)

      if [[ -z "$wallpaper_id" ]]; then
        echo "Error: No wallpaper currently set" >&2
        exit 1
      fi

      log_wallpaper_action "dislike" "$wallpaper_id" "$current_theme" "$message"
      sync_after_action

      local wp_type="${wallpaper_id%%:*}"
      local wp_value="${wallpaper_id#*:}"
      echo "Disliked wallpaper for theme: $current_theme"
      if [[ "$wp_type" == "recolor" ]]; then
        echo "  Wallpaper: recolor ($(basename "$wp_value"))"
      else
        echo "  Wallpaper: $wp_value"
      fi
      [[ -n "$message" ]] && echo "  Note: $message"
      ;;
    reject)
      local message="${*:3}"
      local wallpaper_id current_theme
      wallpaper_id=$(get_current_wallpaper)
      current_theme=$(get_current_theme)

      if [[ -z "$wallpaper_id" ]]; then
        echo "Error: No wallpaper currently set" >&2
        exit 1
      fi

      if [[ -z "$message" ]]; then
        echo "Error: Rejection reason required" >&2
        echo "Usage: theme wallpaper reject <reason>" >&2
        exit 1
      fi

      log_wallpaper_action "reject" "$wallpaper_id" "$current_theme" "$message"
      sync_after_action

      local wp_type="${wallpaper_id%%:*}"
      local wp_value="${wallpaper_id#*:}"
      echo "Rejected wallpaper for theme: $current_theme"
      if [[ "$wp_type" == "recolor" ]]; then
        echo "  Wallpaper: recolor ($(basename "$wp_value"))"
      else
        echo "  Wallpaper: $wp_value"
      fi
      echo "  Reason: $message"
      echo ""
      echo "This wallpaper will be skipped for this theme."
      ;;
    history)
      sync_before_read
      local history
      history=$(get_wallpaper_history)

      if [[ -z "$history" ]] || [[ "$history" == "[]" ]]; then
        echo "No wallpaper history yet."
        return
      fi

      echo ""
      echo "Wallpaper History"
      echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      echo ""

      echo "$history" | jq -r '.[] | "\(.ts) | \(.machine) | \(.theme) | \(.action) | \(.wallpaper)" + (if .message then " | \(.message)" else "" end)' | tail -20
      ;;
    rank)
      sync_before_read
      local current_theme global_flag
      current_theme=$(get_current_theme)
      global_flag="${3:-}"

      local rankings
      if [[ "$global_flag" == "--global" ]]; then
        echo ""
        echo "Global Wallpaper Rankings"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        rankings=$(get_wallpaper_rankings)
      else
        echo ""
        echo "Wallpaper Rankings for: $current_theme"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        rankings=$(get_wallpaper_rankings "$current_theme")
      fi

      if [[ -z "$rankings" ]]; then
        echo ""
        echo "No rankings yet. Apply and rate some wallpapers!"
        return
      fi

      echo ""
      local rank=0
      while IFS= read -r line; do
        rank=$((rank + 1))
        local wallpaper score likes dislikes applies
        wallpaper=$(echo "$line" | jq -r '.wallpaper')
        score=$(echo "$line" | jq -r '.score')
        likes=$(echo "$line" | jq -r '.likes')
        dislikes=$(echo "$line" | jq -r '.dislikes')
        applies=$(echo "$line" | jq -r '.applies')

        local wp_type="${wallpaper%%:*}"
        local wp_value="${wallpaper#*:}"
        local display_name
        if [[ "$wp_type" == "recolor" ]]; then
          display_name="recolor: $(basename "$wp_value")"
        else
          display_name="$wallpaper"
        fi

        printf "%2d. %s\n" "$rank" "$display_name"
        printf "    Score: %+d (%d likes, %d dislikes) | Applied: %d times\n" "$score" "$likes" "$dislikes" "$applies"
      done <<< "$rankings"
      echo ""
      ;;
    source)
      case "${3:-list}" in
      add)
        if [[ -z "${4:-}" ]]; then
          echo "Usage: theme wallpaper source add <path>" >&2
          exit 1
        fi
        add_wallpaper_source "$4"
        ;;
      list)
        local entries
        entries=$(list_wallpaper_source_entries)
        if [[ -z "$entries" ]]; then
          echo "No wallpaper sources configured."
          echo ""
          echo "Add sources with: theme wallpaper source add <path>"
          echo "You can add individual files or entire directories."
          echo ""
          echo "Sources are stored as path references in:"
          echo "  $WALLPAPER_SOURCES_FILE"
        else
          echo "Wallpaper Sources"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          while IFS= read -r entry; do
            local type="${entry%%:*}"
            local path="${entry#*:}"
            if [[ "$type" == "dir" ]]; then
              local count
              count=$(find "$path" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) 2>/dev/null | wc -l | xargs)
              echo "  [dir]  $path ($count images)"
            else
              echo "  [file] $path"
            fi
          done <<< "$entries"
          echo ""
          echo "Total images: $(get_all_wallpaper_images | wc -l | xargs)"
          echo ""
          echo "When 'recolor' style is selected, gowall converts these to match your theme."
        fi
        ;;
      remove)
        if [[ -z "${4:-}" ]]; then
          echo "Usage: theme wallpaper source remove <path>" >&2
          exit 1
        fi
        remove_wallpaper_source "$4"
        ;;
      verify)
        echo "Verifying wallpaper sources..."
        echo ""
        verify_wallpaper_sources
        ;;
      clean)
        echo "Cleaning broken wallpaper sources..."
        echo ""
        clean_wallpaper_sources
        ;;
      *)
        echo "Unknown wallpaper source command: ${3:-}"
        echo "Usage: theme wallpaper source [add|list|remove|verify|clean]"
        exit 1
        ;;
      esac
      ;;
    *)
      echo "Unknown wallpaper command: ${2:-}"
      echo "Usage: theme wallpaper [rotate|source]"
      exit 1
      ;;
    esac
    ;;
  sync)
    case "${2:-status}" in
    init)
      sync_init
      ;;
    status)
      sync_status
      ;;
    push)
      if sync_push; then
        echo "‚úì Pushed to remote"
      else
        echo "‚úó Push failed" >&2
        exit 1
      fi
      ;;
    pull)
      if sync_pull; then
        echo "‚úì Pulled from remote"
      else
        echo "‚úó Pull failed" >&2
        exit 1
      fi
      ;;
    off)
      sync_off
      ;;
    on)
      sync_on
      ;;
    *)
      echo "Usage: theme sync <init|status|push|pull|on|off>"
      exit 1
      ;;
    esac
    ;;
  help | --help | -h)
    usage
    ;;
  *)
    usage
    exit 1
    ;;
  esac
}

main "$@"
